<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ROMIX - Detalle</title>

  <!-- OG / Twitter -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="ROMIX" />
  <meta property="og:title" content="ROMIX | Moda y deportes para todos" />
  <meta property="og:description" content="Catálogo completo de ropa para mujer, hombre y niños. Compra online con envíos rápidos y atención personalizada." />
  <meta property="og:image" content="https://raw.githubusercontent.com/Leandro18122022/web/main/frontend/public/images/logo-romix.png" />
  <meta property="og:url" content="https://romix.com/" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="ROMIX | Moda y deportes para todos" />
  <meta name="twitter:description" content="Catálogo completo de ropa para mujer, hombre y niños. Compra online con envíos rápidos y atención personalizada." />
  <meta name="twitter:image" content="https://raw.githubusercontent.com/Leandro18122022/web/main/frontend/public/images/logo-romix.png" />

  <!-- Icons -->
  <link rel="icon" href="images/logo-romix.png" type="image/png" sizes="64x64" />
  <link rel="apple-touch-icon" href="images/logo-romix.png" />

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

  <style>
    :root { --primary:#e83e8c; --secondary:#6f42c1; --success:#28a745; --danger:#dc3545; --muted:#6c757d; }
    * { box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { margin:0; background:#fff1f6; color:#232323; }
    header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color:#fff; padding:14px 0 10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); position: sticky; top:0; z-index:1000; }
    .header-container { max-width:1600px; margin:0 auto; padding:0 28px; display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:16px; }
    .logo { font-size:1.8rem; font-weight:800; display:flex; align-items:center; gap:10px; text-decoration:none; color:#fff; letter-spacing:-0.5px; }
    .logo .logo-mark { width:40px; height:40px; object-fit:contain; display:block; }
    .global-search { display:flex; align-items:center; gap:0; position:relative; max-width:740px; width:100%; margin:0 auto; }
    .global-search input[type="search"] { padding:10px 14px; border:1px solid rgba(255,255,255,.45); border-radius:999px 0 0 999px; min-width:320px; color:#111; background:#fff; caret-color: var(--secondary); width:100%; }
    .global-search input[type="search"]::placeholder { color:#6c757d; }
    .global-search input[type="search"]::selection { background:#ffe0f0; color:#111; }
    .global-search button { padding:10px 16px; border-radius:0 999px 999px 0; border:1px solid rgba(255,255,255,.45); background:#fff; color:var(--primary); cursor:pointer; font-weight:800; }
    .topbar-icons { display:flex; align-items:center; gap:12px; }
    .icon-btn { width:36px; height:36px; border-radius:50%; border:1px solid rgba(255,255,255,.35); background:rgba(255,255,255,.08); color:#fff; display:inline-flex; align-items:center; justify-content:center; text-decoration:none; position:relative; }
    .icon-badge { position:absolute; top:-6px; right:-6px; background:var(--danger); color:#fff; border-radius:999px; font-size:.7rem; padding:2px 6px; }
    .nav-secondary { max-width:1600px; margin:8px auto 0; padding:0 28px 10px; display:flex; gap:14px; align-items:center; flex-wrap:nowrap; overflow-x:auto; color:#fff; font-weight:700; scrollbar-width:none; }
    .nav-secondary a { color:#fff; text-decoration:none; padding:10px 12px; border-radius:12px; transition:background .2s ease, color .2s ease; }
    .nav-secondary a:hover { background:rgba(255,255,255,.12); }
    .cat-pill { background:rgba(255,255,255,.16); color:#fff; border:1px solid rgba(255,255,255,.35); padding:8px 12px; border-radius:999px; font-weight:700; text-decoration:none; font-size:.95rem; }

    .container { max-width:1600px; margin:20px auto; padding:0 28px; }
    .card { background:#fff; border-radius:16px; padding:20px; box-shadow:0 14px 36px rgba(0,0,0,.10); }
    .detail { display:grid; grid-template-columns: 1.2fr 1fr; gap:24px; }
    .thumb { background:#fff; border-radius:12px; display:flex; align-items:center; justify-content:center; min-height:420px; }
    .thumb img { max-width:100%; max-height:100%; object-fit:contain; }
    .title { font-size:2rem; font-weight:900; margin:6px 0 10px; color:#1b1f24; }
    .price { font-size:1.8rem; color:var(--primary); font-weight:900; margin-bottom:8px; }
    .pill { display:inline-flex; align-items:center; gap:6px; background:#e9f7ef; color:#207a3a; border:1px solid #ccebd8; padding:6px 10px; border-radius:999px; font-weight:800; }
    .muted { color: var(--muted); }
    .section { margin-top:16px; }
    .qty-row { display:flex; align-items:center; gap:10px; margin:12px 0; flex-wrap:wrap; }
    .qty-btn { width:36px; height:36px; border-radius:8px; border:1px solid #dee2e6; background:#fff; font-weight:900; cursor:pointer; }
    .qty-input { width:64px; height:36px; border:1px solid #dee2e6; border-radius:8px; text-align:center; }
    .max-note { color:#6c757d; font-weight:700; }
    .cta { display:block; width:100%; padding:14px 16px; border-radius:10px; border:none; background: linear-gradient(135deg, var(--primary), var(--secondary)); color:#fff; font-weight:900; cursor:pointer; margin-top:6px; }
    .cta:disabled { filter: grayscale(1); opacity:.6; cursor:not-allowed; }
    hr { border:none; border-top:1px solid #eee; margin:18px 0; }
    .policy li { margin:6px 0; color:#495057; }
    @media (max-width: 980px){ .detail{ grid-template-columns:1fr; } .thumb{ min-height:300px; } }
  </style>

  <link rel="stylesheet" href="assets/css/responsive.css" />
  <script src="assets/js/slugify.js"></script>
  <script src="assets/js/cart.js"></script>
  <script src="assets/js/products-store.js"></script>

  <script>
    const PLACEHOLDER = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`\
      <svg xmlns="http://www.w3.org/2000/svg" width="1000" height="700">\
        <rect width="100%" height="100%" fill="#f8f9fb"/>\
        <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#adb5bd" font-family="Segoe UI, sans-serif" font-size="28">Imagen no disponible</text>\
      </svg>`);

    const sharedSlugify = (function(){
      if (typeof window.romixSlugify === 'function') return window.romixSlugify;
      if (typeof window.slugify === 'function') return window.slugify;
      if (window.romix && typeof window.romix.slugify === 'function') return window.romix.slugify;
      // No tires error acá: dejá que la página cargue igual y falle “suave”
      return (s) => String(s || '').trim().toLowerCase().replace(/\s+/g, '-');
    })();

    function estimateStock(p){
      try{
        if (typeof p.stock === 'number') return Math.max(0, p.stock);
        const sizes = Array.isArray(p.sizes) ? p.sizes : [];
        const perSize = sizes.reduce((t, s)=>{
          const st = String(s.status||'').toLowerCase();
          if (st.includes('out') || st.includes('unavail')) return t;
          if (st.includes('low')) return t + 2;
          return t + 5;
        },0);
        const colors = Array.isArray(p.colors) && p.colors.length
          ? p.colors.length
          : (p.images ? Object.keys(p.images).length : 1);
        return perSize * Math.max(1, colors);
      }catch{
        return 0;
      }
    }

    function updateCartCount(){
      try { if (window.romixCart && typeof window.romixCart.updateBadge === 'function') window.romixCart.updateBadge(); }
      catch {}
    }

    function render(p){
      const root = document.getElementById('root');
      if(!root){
        return;
      }
      if(!p){
        root.innerHTML = '<p>No se encontró el producto.</p>';
        return;
      }

      const img = p.image || (p.images && (p.images['Negro'] || Object.values(p.images)[0])) || PLACEHOLDER;
      const price = Number(p.price||0);
      const stock = estimateStock(p);
      const stockLabel = stock <= 0 ? 'Agotado' : (stock <= 3 ? 'Por agotarse' : 'Disponible');

      const badge = p.type
        ? `<span class="muted" style="background:#f1f3f5;border-radius:999px;padding:6px 10px;font-weight:800;">${p.type}</span>`
        : '';

      root.innerHTML = `
        <div class="card detail">
          <div class="thumb">
            <img src="${img}" alt="${p.name || ''}" onerror="this.onerror=null;this.src='${PLACEHOLDER}';"/>
          </div>
          <div>
            <div style="margin-bottom:6px;">${badge}</div>
            <div class="title">${p.name || 'Producto'}</div>
            <div class="price">$${price.toLocaleString('es-AR')}</div>

            <div class="pill">
              <i class="fas fa-check-circle" aria-hidden="true"></i>
              ${stockLabel}
            </div>

            <div class="section">
              <div style="font-weight:800;margin-bottom:6px;color:#1b1f24">Descripción</div>
              <div class="muted">${p.description || p.desc || p.subtitle || p.type || ''}</div>
            </div>

            <div class="section">
              <div style="font-weight:800;margin-bottom:6px;color:#1b1f24">Cantidad</div>
              <div class="qty-row">
                <button id="dec" type="button" class="qty-btn" aria-label="Disminuir">-</button>
                <input id="qty" class="qty-input" type="number" min="1" value="1" />
                <button id="inc" type="button" class="qty-btn" aria-label="Aumentar">+</button>
              </div>

              <button id="add" class="cta">
                <i class="fas fa-shopping-cart" aria-hidden="true"></i>
                <span id="btnText">Agregar al Carrito - $${price.toLocaleString('es-AR')}</span>
              </button>
            </div>

            <hr />

            <div class="section">
              <div style="font-weight:800;margin-bottom:6px;color:#1b1f24">Políticas de Devolución</div>
              <ul class="policy">
                <li>Devoluciones aceptadas dentro de 7 días</li>
                <li>Productos en perfecto estado</li>
                <li>Garantía de 5 días en flores frescas</li>
                <li>Garantía de 30 días en floreros</li>
              </ul>
            </div>
          </div>
        </div>
      `;

      const qty = document.getElementById('qty');
      const dec = document.getElementById('dec');
      const inc = document.getElementById('inc');
      const add = document.getElementById('add');
      const btnText = document.getElementById('btnText');
      const max = Math.max(0, stock);

      const updateButton = ()=>{
        const q = Math.max(1, Math.min(parseInt(qty.value, 10) || 1, Math.max(1, max)));
        qty.value = q;
        btnText.textContent = `Agregar al Carrito - $${(price*q).toLocaleString('es-AR')}`;
        add.disabled = max <= 0;
      };

      dec.addEventListener('click', ()=>{
        qty.value = Math.max(1, (parseInt(qty.value, 10) || 1) - 1);
        updateButton();
      });

      inc.addEventListener('click', ()=>{
        qty.value = Math.min(Math.max(1, max), (parseInt(qty.value, 10) || 1) + 1);
        updateButton();
      });

      qty.addEventListener('input', updateButton);
      updateButton();

      add.addEventListener('click', ()=>{
        const q = Math.max(1, Math.min(parseInt(qty.value, 10) || 1, Math.max(1, max)));

        const color =
          (p.colors && p.colors[0] && (p.colors[0].name || p.colors[0])) ||
          'Único';

        const size =
          (Array.isArray(p.sizes) && p.sizes[0] && p.sizes[0].size)
            ? String(p.sizes[0].size)
            : 'U';

        if (window.romixCart && typeof window.romixCart.addToCart === 'function') {
          window.romixCart.addToCart({
            productId: p.id || sharedSlugify(p.name || ''),
            name: p.name || '',
            type: p.type || '',
            color,
            colorName: color,
            size,
            price,
            qty: q
          });

          if (typeof window.romixCart.updateBadge === 'function') {
            window.romixCart.updateBadge();
          }
        } else {
          console.warn('[detalle] romixCart.addToCart no está disponible');
        }

        alert('¡Listo! Se agregó al carrito.');
      });
    }

    function preloadedProducts(){
      try {
        const el = document.getElementById('preloaded-products');
        if (!el) return null;
        const raw = (el.textContent || el.innerText || '').trim();
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        return (typeof sanitizeList === 'function')
          ? sanitizeList(Array.isArray(parsed) ? parsed : [])
          : (Array.isArray(parsed) ? parsed : []);
      } catch (error) {
        console.error('[detalle] Error parseando preloaded-products:', error);
        return null;
      }
    }

    async function fetchProductList(){
      if (window.romixProductsStore && typeof window.romixProductsStore.load === 'function') {
        return window.romixProductsStore.load({ preloadedScriptId: 'preloaded-products' });
      }
      const dataUrl = new URL('assets/data/products.json', location.href).href;
      const res = await fetch(dataUrl);
      const parsed = await res.json();
      return (typeof sanitizeList === 'function')
        ? sanitizeList(Array.isArray(parsed) ? parsed : [])
        : (Array.isArray(parsed) ? parsed : []);
    }

    async function init(){
      updateCartCount();

      const params = new URLSearchParams(location.search);
      const idParam = (params.get('id') || '').trim();
      const slugParam = (params.get('slug') || '').trim();
      const nameParamRaw = params.get('name') || '';
      const q = (params.get('q') || '').trim();

      const nameParam = (typeof window.fixUtf8 === 'function')
        ? window.fixUtf8(nameParamRaw).trim()
        : (nameParamRaw || '').trim();

      try{
        let list = preloadedProducts();
        if (!Array.isArray(list) || !list.length) list = await fetchProductList();
        const products = Array.isArray(list) ? list : [];

        let product = null;

        if (idParam) {
          product = products.find(p => {
            const pid = (typeof window.productId === 'function')
              ? window.productId(p)
              : sharedSlugify(p.name);
            return pid === idParam;
          });
        }

        if (!product && slugParam) {
          product = products.find(p => {
            const slug = (typeof window.romixSlug === 'function')
              ? window.romixSlug(p.name || '')
              : sharedSlugify(p.name || '');
            return slug === slugParam;
          });
        }

        if (!product && nameParam) {
          product = products.find(p => {
            const normalized = (typeof window.fixUtf8 === 'function'
              ? window.fixUtf8(String(p.name || ''))
              : String(p.name || '')).trim();
            return normalized === nameParam;
          }) || products.find(p => {
            const normalized = (typeof window.fixUtf8 === 'function'
              ? window.fixUtf8(String(p.name || ''))
              : String(p.name || '')).toLowerCase();
            return normalized.startsWith(nameParam.toLowerCase());
          });
        }

        if (!product && q) {
          const nq = q.toLowerCase();
          product = products.find(x => String(x.name||'').toLowerCase().includes(nq));
        }

        if (!product) {
          const root = document.getElementById('root');
          if (root) root.innerHTML = '<p>No se encontró el producto.</p>';
          return;
        }

        render(product);
      }catch(e){
        console.error('[detalle] Error al cargar el producto:', e);
        const root = document.getElementById('root');
        if (root) root.innerHTML = '<p>Error al cargar el producto.</p>';
      }
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</head>

<body>
  <header>
    <div class="header-container topbar">
      <a href="index.html" class="logo" aria-label="Romix">
        <img src="images/logo-romix.png" class="logo-mark" alt="Logo Romix" />
        <span>ROMIX</span>
      </a>

      <form id="global-search-form" class="global-search" role="search" aria-label="Buscar productos" action="catalogo.html" method="get">
        <input type="search" name="q" placeholder="Buscar productos..." aria-label="Buscar producto" />
        <button type="submit" aria-label="Buscar">
          <i class="fas fa-search" aria-hidden="true"></i>
        </button>
      </form>

      <div class="topbar-icons" aria-label="Acciones">
        <a class="icon-btn" href="cart.html" aria-label="Carrito">
          <i class="fas fa-shopping-cart" aria-hidden="true"></i>
          <span class="icon-badge" id="cart-count">0</span>
        </a>
        <a class="icon-btn" href="ayuda.html" aria-label="Ayuda">
          <i class="fas fa-question-circle" aria-hidden="true"></i>
        </a>
      </div>
    </div>

    <nav class="nav-secondary" aria-label="Secciones y categorías">
      <a href="mujer.html">Mujer</a>
      <a href="hombre.html">Hombre</a>
      <a href="ninos.html">Niños</a>
      <a href="novedades.html">Novedades</a>
      <a href="ayuda.html">Ayuda</a>
    </nav>
  </header>

  <main class="container">
    <div id="root"></div>
  </main>
</body>
</html>
