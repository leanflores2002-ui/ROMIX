<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ROMIX - Detalle</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <style>
    :root {
      --primary: #e83e8c;
      --secondary: #6f42c1;
      --success: #28a745;
      --danger: #dc3545;
      --muted: #6c757d;
      --card-bg: #fff;
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #f5f5f5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #222;
    }
    header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      padding: 14px 0 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,.12);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .header-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 28px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 16px;
    }
    .logo {
      font-size: 1.8rem;
      font-weight: 800;
      text-decoration: none;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo .logo-mark {
      width: 40px;
      height: 40px;
      object-fit: contain;
      display: block;
    }
    .global-search {
      display: flex;
      align-items: center;
      gap: 0;
      position: relative;
      max-width: 640px;
      width: 100%;
    }
    .global-search input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid rgba(255,255,255,.45);
      border-radius: 999px 0 0 999px;
      font-size: 1rem;
      color: #111;
      outline: none;
      background: #fff;
    }
    .global-search button {
      border: 1px solid rgba(255,255,255,.45);
      border-left: none;
      border-radius: 0 999px 999px 0;
      padding: 10px 16px;
      background: #fff;
      color: var(--primary);
      cursor: pointer;
      font-weight: 700;
    }
    .topbar-icons {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .icon-btn {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.4);
      color: #fff;
      text-decoration: none;
    }
    .icon-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #dc3545;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: .7rem;
      font-weight: 700;
    }
    .nav-secondary {
      max-width: 1600px;
      margin: 8px auto 0;
      padding: 0 28px 10px;
      display: flex;
      gap: 12px;
      flex-wrap: nowrap;
      overflow-x: auto;
      color: #fff;
      font-weight: 700;
    }
    .nav-secondary a {
      text-decoration: none;
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.25);
      transition: background .2s;
    }
    .nav-secondary a:hover {
      background: rgba(255,255,255,.15);
    }
    .page-container {
      max-width: 1200px;
      margin: 24px auto 48px;
      padding: 0 28px;
    }
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #6c757d;
      text-decoration: none;
      font-weight: 700;
      margin-bottom: 12px;
    }
    .detail-panel {
      background: #fff;
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: 0 16px 36px rgba(0,0,0,.08);
      margin-top: 8px;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 24px;
      align-items: flex-start;
    }
    .gallery {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }
    .main-image {
      flex: 1;
      min-height: 380px;
      background: #f6f6f8;
      border-radius: 16px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 1px solid #ececec;
      cursor: zoom-in;
    }
    .main-image:focus-visible {
      outline: 3px solid rgba(111, 66, 193, 0.55);
      outline-offset: 4px;
    }
    .main-image img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .zoom-btn {
      position: absolute;
      right: 12px;
      bottom: 12px;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: 1px solid rgba(0,0,0,.1);
      background: #fff;
      color: #111;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,.12);
    }
    .zoom-btn:focus-visible,
    .zoom-close:focus-visible,
    .zoom-nav:focus-visible {
      outline: 3px solid rgba(255, 255, 255, 0.85);
      outline-offset: 2px;
    }
    .zoom-btn:hover { transform: translateY(-1px); }
    .zoom-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.72);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 16px;
    }
    .zoom-modal.is-open { display: flex; }
    .zoom-panel {
      position: relative;
      background: #fff;
      border-radius: 6px;
      padding: 10px;
      max-width: 92vw;
      max-height: 92vh;
      box-shadow: 0 24px 48px rgba(0,0,0,.35);
    }
    .zoom-stage {
      width: min(82vw, 980px);
      height: min(80vh, 720px);
      background: #fff;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .zoom-stage img {
      max-width: 100%;
      max-height: 100%;
      transform-origin: center;
      cursor: zoom-in;
      user-select: none;
    }
    .zoom-stage.is-zoomed img {
      cursor: zoom-out;
    }
    .zoom-stage.dragging img { cursor: grabbing; }
    .zoom-close {
      border: 1px solid rgba(0,0,0,.15);
      background: #fff;
      color: #111;
      border-radius: 999px;
      font-weight: 800;
      width: 36px;
      height: 36px;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,.12);
    }
    .zoom-close {
      position: absolute;
      top: -46px;
      right: -2px;
      width: 38px;
      height: 38px;
      border: 0;
      background: transparent;
      color: #fff;
      box-shadow: none;
    }
    .zoom-counter {
      position: absolute;
      top: -40px;
      left: 0;
      color: #fff;
      font-weight: 700;
      font-size: 0.95rem;
    }
    .zoom-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 44px;
      height: 56px;
      border-radius: 6px;
      border: 0;
      background: rgba(0,0,0,.55);
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .zoom-nav.prev { left: -60px; }
    .zoom-nav.next { right: -60px; }
    .zoom-nav:disabled { opacity: .4; cursor: default; }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    @media (hover: none){
      .zoom-close {
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,.55);
      }
      .zoom-counter { top: 12px; left: 12px; }
      .zoom-nav.prev { left: 8px; }
      .zoom-nav.next { right: 8px; }
    }
    .thumbs {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 96px;
    }
    .thumbs img {
      width: 96px;
      height: 88px;
      border-radius: 10px;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color .2s;
    }
    .thumbs img.active {
      border-color: var(--primary);
    }
    .info-panel {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .title-row {
      display: flex;
      align-items: baseline;
      gap: 12px;
    }
    .title-row h1 {
      margin: 0;
      font-size: 2rem;
      font-weight: 900;
      color: #111;
    }
    .meta-pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .meta-pill {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 999px;
      background: #f5f6f9;
      color: #3f3f46;
      font-weight: 700;
      font-size: 0.85rem;
    }
    .price-area {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .current-price {
      display: inline-block;
      min-width: 120px;
      font-size: 2.1rem;
      font-weight: 900;
      color: var(--secondary);
    }
    .original-price {
      font-size: 1rem;
      text-decoration: line-through;
      color: #6c757d;
    }
    .stock-note {
      font-size: 0.95rem;
      color: #555;
    }
    .detail-description {
      margin: 0;
      color: #4f4f4f;
      line-height: 1.6;
      font-size: 0.95rem;
    }
    .selector {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .selector-label {
      font-weight: 700;
      color: #4b4b4b;
      font-size: 0.9rem;
    }
    #colorPicker {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .color-picker-label {
      margin: 0;
      font-size: 0.95rem;
      color: #3f3f46;
    }
    .color-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .color-option,
    .color-swatch {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 2px solid #d9d9df;
      background-color: var(--color-value, #000);
      cursor: pointer;
      position: relative;
      transition: transform .2s, border-color .2s, box-shadow .2s;
    }
    .color-swatch.has-image,
    .color-option.has-image {
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      border-radius: 12px;
      width: 42px;
      height: 42px;
    }
    .color-option::after,
    .color-swatch::after {
      content: '';
      position: absolute;
      inset: 6px;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,.85);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.04);
    }
    .color-option.selected,
    .color-swatch.active,
    .color-swatch.selected,
    .color-option.active {
      border-color: #3f3f46;
      transform: scale(1.05);
      box-shadow: 0 0 0 3px rgba(111,66,193,.2), 0 0 0 1px rgba(0,0,0,.06);
    }
    .color-option:focus-visible,
    .color-swatch:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    .size-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .size-chip {
      border-radius: 12px;
      border: 1px solid #d6d8db;
      padding: 8px 12px;
      background: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: box-shadow .2s, border-color .2s;
    }
    .size-chip.selected {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(232,62,140,.2);
    }
    .size-chip[data-state='low'] {
      background: #fff8e1;
      border-color: #f0c36d;
    }
    .size-chip[data-state='out'] {
      background: #f3f5f7;
      color: #8a8a92;
      border-color: #e3e5e8;
      cursor: not-allowed;
      text-decoration: line-through;
    }
    .stock-detail {
      font-size: 0.9rem;
      color: #5a5a5a;
      margin-top: 4px;
    }
    .quantity-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .qty-control {
      display: inline-flex;
      align-items: center;
      background: #f2f2f4;
      border-radius: 10px;
      padding: 4px;
      gap: 4px;
    }
    .qty-control button {
      border: none;
      background: transparent;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      font-size: 1.4rem;
      color: #333;
      cursor: pointer;
    }
    .qty-control input {
      width: 60px;
      text-align: center;
      border: none;
      background: transparent;
      font-size: 1rem;
    }
    .purchase-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .btn {
      border-radius: 12px;
      border: none;
      padding: 12px 18px;
      font-weight: 800;
      font-size: 1rem;
      cursor: pointer;
    }
    .btn.primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      box-shadow: 0 12px 18px rgba(111,66,193,.25);
    }
    .btn.outline {
      background: #fff;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    .features-panel, .related-panel {
      margin-top: 24px;
      background: #fff;
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: 0 16px 36px rgba(0,0,0,.08);
    }
    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .feature-card {
      border-radius: 12px;
      border: 1px solid #f0f0f0;
      padding: 14px;
      background: #fafafa;
      font-size: 0.95rem;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .feature-card strong {
      font-weight: 700;
      color: #34343f;
    }
    .stock-info-color {
      margin-top: 4px;
      font-size: 0.9rem;
      color: #495057;
    }
    .size-option {
      transition: background-color .2s ease, color .2s ease, border-color .2s ease;
    }
    .size-option--available {
      background-color: #28a745;
      color: #fff;
    }
    .size-option--low {
      background-color: #ffc107;
      color: #212529;
    }
    .size-option--out {
      background-color: #dc3545;
      color: #fff;
      opacity: 0.7;
    }
    .size-option--out[disabled] {
      cursor: not-allowed;
    }
    .size-option--active {
      box-shadow: 0 0 0 2px var(--primary);
    }
    .related-products {
      margin-top: 40px;
    }
    .related-title {
      font-size: 1.4rem;
      font-weight: 800;
      color: #111;
      margin-bottom: 18px;
    }
    .related-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
    }
    .related-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.06);
      padding: 10px;
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .related-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 24px rgba(0,0,0,0.10);
    }
    .related-card-thumb {
      width: 100%;
      height: 160px;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 8px;
      background:#f8f9fb;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .related-card-thumb img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .related-card-name {
      font-size: 0.9rem;
      font-weight: 700;
      color: #111;
      margin-bottom: 4px;
    }
    .related-card-price {
      font-size: 0.95rem;
      font-weight: 800;
      color: var(--primary);
    }
    .related-card-meta {
      font-size: 0.8rem;
      color: #6c757d;
      margin-top: 2px;
    }
    @media (max-width: 600px){
      .related-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    footer {
      background: #343a40;
      color: #fff;
      padding: 30px 0 40px;
    }
    footer .footer-wrap {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 28px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 24px;
    }
    footer h4 {
      margin-bottom: 15px;
      color: #e83e8c;
    }
    footer a {
      color: #adb5bd;
      text-decoration: none;
    }
    footer a:hover {
      color: #fff;
    }
    .romix-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      max-width: 280px;
      padding: 10px 14px;
      border-radius: 12px;
      background: #ffffff;
      color: #343a40;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      font-size: 0.9rem;
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: opacity .25s ease, transform .25s ease;
      z-index: 1500;
    }

    .romix-toast--success {
      border: 2px solid var(--primary);
    }

    .romix-toast--error {
      border: 2px solid var(--danger);
    }

    .romix-toast--visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    @media (max-width: 960px) {
      .detail-grid {
        grid-template-columns: 1fr;
      }
      .gallery {
        flex-direction: column;
      }
      .thumbs {
        flex-direction: row;
        width: 100%;
        justify-content: flex-start;
      }
      .thumbs img {
        width: 76px;
        height: 76px;
      }
      .info-panel {
        gap: 14px;
      }
    }
  </style>
  <link rel="stylesheet" href="assets/css/responsive.css">
  <script id="preloaded-products" type="application/json">
    {{ products_json if products_json is defined else "[]" }}
  </script>
  <link rel="icon" href="images/logo-romix.png" type="image/png" sizes="64x64" />
  <link rel="apple-touch-icon" href="images/logo-romix.png" />
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="ROMIX">
  <meta property="og:title" content="ROMIX | Moda y deportes para todos">
  <meta property="og:description" content="Catalogo completo de ropa para mujer, hombre y ninos. Compra online con envios rapidos y atencion personalizada.">
  <meta property="og:image" content="https://raw.githubusercontent.com/Leandro18122022/web/main/frontend/public/images/logo-romix.png">
  <meta property="og:url" content="https://romix.com/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ROMIX | Moda y deportes para todos">
  <meta name="twitter:description" content="Catalogo completo de ropa para mujer, hombre y ninos. Compra online con envios rapidos y atencion personalizada.">
  <meta name="twitter:image" content="https://raw.githubusercontent.com/Leandro18122022/web/main/frontend/public/images/logo-romix.png">  <link rel="stylesheet" href="assets/css/romix-header.css">
</head>
<body>
  <header>
    <div class="header-container topbar">
      <a href="index.html" class="logo" aria-label="Romix"><img src="images/logo-romix.png" class="logo-mark" alt="Logo Romix" /><span>ROMIX</span></a>
      <form id="global-search-form" class="global-search" role="search" aria-label="Buscar productos">
        <input type="search" name="q" placeholder="Buscar productos..." aria-label="Buscar producto" />
        <button type="submit"><i class="fas fa-search" aria-hidden="true"></i></button>
      </form>
      <div class="topbar-icons" aria-label="Acciones">
        <a class="icon-btn" href="cart.html" aria-label="Carrito"><i class="fas fa-shopping-cart"></i><span id="cart-count" class="icon-badge">0</span></a>
        <a class="icon-btn" href="ayuda.html" aria-label="Ayuda"><i class="fas fa-question-circle"></i></a>
      </div>
    </div>
    <nav class="nav-secondary" aria-label="Secciones y categorías">
      <a href="mujer.html">Mujer</a>
      <a href="hombre.html">Hombre</a>
      <a href="ninos.html">Niños</a>
      <a href="novedades.html">Novedades</a>
      <a href="ayuda.html">Ayuda</a>
    </nav>
  </header>

  <main class="page-container">
    <a class="back-link" href="index.html"><i class="fas fa-arrow-left" aria-hidden="true"></i> Volver al inicio</a>
    <section id="product-detail" class="detail-panel" aria-live="polite">
      <p class="status">Cargando producto...</p>
    </section>
    <section id="features-section" class="features-panel" hidden>
      <h3>Características del producto</h3>
      <div id="features-grid" class="features-grid" aria-live="polite"></div>
    </section>
    <section class="related-products">
      <h2 class="related-title">Nuestros clientes también vieron</h2>
      <div id="related-grid" class="related-grid"></div>
    </section>
  </main>

  <footer>
    <div class="footer-wrap" role="contentinfo">
      <div>
        <h4>Productos</h4>
        <ul style="list-style:none;padding:0;margin:0;">
          <li><a href="mujer.html">Ropa para Mujer</a></li>
          <li><a href="hombre.html">Ropa para Hombre</a></li>
          <li><a href="ninos.html">Ropa para Niños</a></li>
          <li><a href="novedades.html">Novedades</a></li>
          <li><a href="index.html#ofertas">Ofertas</a></li>
        </ul>
      </div>
      <div>
        <h4>Ayuda</h4>
        <ul style="list-style:none;padding:0;margin:0;">
          <li><a href="ayuda.html#size-guide">Guía de talles</a></li>
          <li><a href="ayuda.html#returns">Política de Cambios</a></li>
        </ul>
      </div>
      <div>
        <h4>Contacto</h4>
        <ul style="list-style:none;padding:0;margin:0;">
          <li><a href="ayuda.html#contact">Dirección y horarios</a></li>
          <li><a href="https://wa.me/" target="_blank" rel="noopener">WhatsApp</a></li>
          <li><a href="tel:+549000000000">Llamar por teléfono</a></li>
        </ul>
      </div>
    </div>
    <div style="text-align:center;padding-top:20px;margin-top:20px;border-top:1px solid #495057;color:#adb5bd;font-size:.9rem;">&copy; 2025 Romix - Todos los derechos reservados</div>
  </footer>

  <script src="assets/js/color-utils.js"></script>
  <script src="assets/js/slugify.js"></script>
  <script src="assets/js/cart.js"></script>
  <script src="assets/js/products-store.js"></script>
  <script>
    let romixToastTimer;

    function showToast(message, type = 'success') {
      const el = document.getElementById('romix-toast');
      if (!el) return;

      el.textContent = message || '';

      el.classList.remove('romix-toast--success', 'romix-toast--error');
      if (type === 'error') el.classList.add('romix-toast--error');
      else el.classList.add('romix-toast--success');

      el.classList.add('romix-toast--visible');

      if (romixToastTimer) clearTimeout(romixToastTimer);
      romixToastTimer = setTimeout(() => {
        el.classList.remove('romix-toast--visible');
      }, 2500);
    }
  </script>
  <script>
    (function(){
      const PLACEHOLDER = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="520" height="360"><rect width="100%" height="100%" fill="#f8f9fb"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#adb5bd" font-family="Segoe UI, sans-serif" font-size="20">Imagen no disponible</text></svg>`);
      const DATA_URL = 'assets/data/products.json';
      const CART_KEY = 'cart';
      const sanitizeList = typeof window.sanitizeList === 'function' ? window.sanitizeList : list => Array.isArray(list) ? list : [];
      let currentProduct = null;
      let currentQty = 1;
      let STOCK_MAX = 10;
      let currentSelectedColor = 'Unico';
      let currentSelectedSize = '';
      const colorUtils = typeof window.romixColorUtils === 'object' ? window.romixColorUtils : {};
      const getDisplayColorName = typeof colorUtils.getDisplayColorName === 'function'
        ? colorUtils.getDisplayColorName
        : (product, selected) => (selected || 'Único');
      const normalizeColorName = typeof colorUtils.normalizeColorName === 'function'
        ? colorUtils.normalizeColorName
        : (value) => (value || '').toString().trim();
      function normalizeColorKey(value) {
        const raw = (value ?? '').toString().trim();
        if (!raw) return '';
        try {
          return raw.normalize('NFD').replace(/\p{Diacritic}+/gu, '').toLowerCase();
        } catch {
          return raw.toLowerCase();
        }
      }
      const findColorOption = typeof colorUtils.findColorOption === 'function'
        ? colorUtils.findColorOption
        : (product, lookup) => {
            let palette = [];
            if (Array.isArray(product?.colors)) {
              palette = product.colors;
            } else if (product?.colors && typeof product.colors === 'object') {
              const values = Object.values(product.colors);
              if (values.every(v => v && typeof v === 'object')) {
                palette = values;
              } else if (product.colors.name) {
                palette = [product.colors];
              }
            }
            const target = (lookup || '').toString().toLowerCase();
            return palette.find(opt => (opt?.name || '').toString().toLowerCase() === target) || null;
          };

      const params = new URLSearchParams(location.search);
      const idParam = (params.get('id') || '').trim();
      const slugParam = (params.get('slug') || '').trim();
      const rawName = params.get('name') || '';
      const nameParam = (typeof window.fixUtf8 === 'function' ? window.fixUtf8(rawName) : rawName).trim();
      const buyParam = (params.get('buy') || '').trim();
      const colorParam = (params.get('color') || '').trim();
      const variantParam = (params.get('variant') || '').trim();

      function getPriceGroupForSize(sizeValue, productSection) {
        const sizeNum = Number(sizeValue);
        const section = String(productSection || '').toLowerCase();
        if (section === 'mujer' || section === 'hombre') {
          if (sizeNum >= 1 && sizeNum <= 5) return 'common';
          if (sizeNum >= 6 && sizeNum <= 8) return 'special';
          if (sizeNum === 9 || sizeNum === 10) return 'special2';
        }
        if (section === 'niños' || section === 'ninos' || section === 'nino') {
          if ([2,4,6,8].includes(sizeNum)) return 'common';
          if ([10,12,14,16].includes(sizeNum)) return 'special';
        }
        return null;
      }

      function getPriceForSize(product, sizeValue) {
        const group = getPriceGroupForSize(sizeValue, product.section);
        const base = Number(product.price || 0);
        if (!group || !product.priceByGroup || typeof product.priceByGroup !== 'object') {
          return base;
        }
        const groupPrice = product.priceByGroup[group];
        return groupPrice != null ? Number(groupPrice) : base;
      }

      function initColorPicker(container, labelTarget, swatchSelector) {
        const root = typeof container === 'string' ? document.querySelector(container) : container;
        const labelEl = typeof labelTarget === 'string' ? document.querySelector(labelTarget) : labelTarget;
        const selector = swatchSelector || '.color-swatch';
        if (!root) return null;

        const getSwatches = () => Array.from(root.querySelectorAll(selector));
        const setLabel = (value) => {
          if (labelEl) labelEl.textContent = value || '';
        };

        function applySelection(swatch, silent) {
          if (!swatch) return null;
          const swatches = getSwatches();
          const wasActive = swatch.classList.contains('active') || swatch.getAttribute('aria-pressed') === 'true';
          const name = swatch.dataset.colorName || swatch.dataset.color || swatch.dataset.colorHex || swatch.textContent || '';

          swatches.forEach(btn => {
            const isActive = btn === swatch;
            btn.classList.toggle('active', isActive);
            btn.classList.toggle('selected', isActive);
            btn.classList.toggle('is-active', isActive);
            btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
          });

          setLabel(name || swatch.dataset.colorHex || '');

          if (!silent && !wasActive) {
            root.dispatchEvent(new CustomEvent('colorChange', {
              detail: {
                name: name || swatch.dataset.colorHex || '',
                hex: swatch.dataset.colorHex || '',
                variantId: swatch.dataset.variantId || swatch.dataset.colorVariantId || null,
                swatch
              }
            }));
          }

          return name;
        }

        function selectByName(name, silent) {
          const targetName = (name || '').toString().toLowerCase();
          const swatches = getSwatches();
          const existing = swatches.find(btn =>
            (btn.dataset.colorName || btn.dataset.color || '').toString().toLowerCase() === targetName
          ) || swatches.find(btn => btn.classList.contains('active') || btn.getAttribute('aria-pressed') === 'true') || swatches[0];

          if (!existing) return null;
          return applySelection(existing, silent);
        }

        function handleClick(event) {
          const swatch = event.target.closest(selector);
          if (!swatch || !root.contains(swatch)) return;
          event.preventDefault();
          applySelection(swatch, false);
        }

        function handleKeydown(event) {
          if (event.key !== 'Enter' && event.key !== ' ') return;
          const swatch = event.target.closest(selector);
          if (!swatch || !root.contains(swatch)) return;
          event.preventDefault();
          applySelection(swatch, false);
        }

        root.addEventListener('click', handleClick);
        root.addEventListener('keydown', handleKeydown);

        selectByName(null, true);

        return {
          selectColor: (name, opts = {}) => selectByName(name, opts.silent),
          getSelected: () => getSwatches().find(btn => btn.classList.contains('active'))
        };
      }

      function normalizeSlug(value){
        const safeValue = String(value || '');
        try {
          return safeValue
            .normalize('NFD')
            .replace(/\p{Diacritic}+/gu, '')
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        } catch {
          return safeValue
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        }
      }

      function slugifyName(value){
        if (typeof window.romixSlug === 'function') return window.romixSlug(value);
        if (typeof window.slugify === 'function') return window.slugify(value);
        return normalizeSlug(value);
      }

      function buildHref(product, buy){
        const pid = encodeURIComponent(product && product.id ? String(product.id) : slugifyName(product && product.name));
        const slug = encodeURIComponent(slugifyName(product && product.name));
        const name = encodeURIComponent(String(product && product.name || ''));
        const base = `product.html?id=${pid}&slug=${slug}&name=${name}`;
        return buy ? `${base}&buy=1` : base;
      }

      function readCart(){
        try { return (window.romixCart && window.romixCart.getCart()) || []; }
        catch (error) { console.warn('[detalle] carrito invalido', error); return []; }
      }

      function writeCart(items){
        try { if (window.romixCart) window.romixCart.saveCart(items); }
        catch (error) { console.warn('[detalle] no se pudo guardar el carrito', error); }
      }

      function updateCartCount(){
        try { if (window.romixCart) window.romixCart.updateBadge(); }
        catch (error) { console.warn('[detalle] no pudo actualizar el contador', error); }
      }

      function setQuantity(newQty) {
        let v = Number(newQty) || 1;
        if (v < 1) v = 1;
        if (v > STOCK_MAX) {
          v = STOCK_MAX;
          showToast('Solo podes seleccionar hasta ' + STOCK_MAX + ' unidades para este producto.', 'error');
        }
        currentQty = v;
        const qtySpan = document.getElementById('quantity-value') || document.getElementById('qty');
        if (qtySpan) qtySpan.textContent = String(v);
        const qtyInput = document.getElementById('quantity-input');
        if (qtyInput) qtyInput.value = String(v);
      }

      function getPriceGroupForSize(sizeValue, productSection) {
        const sizeNum = Number(sizeValue);
        const section = String(productSection || '').toLowerCase();
        if (section === 'mujer' || section === 'hombre') {
          if (sizeNum >= 1 && sizeNum <= 5) return 'common';
          if (sizeNum >= 6 && sizeNum <= 8) return 'special';
          if (sizeNum === 9 || sizeNum === 10) return 'special2';
        }
        if (section === 'niños' || section === 'ninos' || section === 'nino') {
          if ([2,4,6,8,10].includes(sizeNum)) return 'common';
          if ([12,14,16].includes(sizeNum)) return 'special';
        }
        return null;
      }

      function getPriceForSize(product, sizeValue) {
        const group = getPriceGroupForSize(sizeValue, product.section);
        const base = Number(product.price || 0);
        if (!group || !product.priceByGroup || typeof product.priceByGroup !== 'object') {
          return base;
        }
        const groupPrice = product.priceByGroup[group];
        return groupPrice != null ? Number(groupPrice) : base;
      }

      function updatePriceForSize(product, sizeValue){
        const priceEl = document.getElementById('product-price');
        if (!priceEl) return;
        const newPrice = getPriceForSize(product, sizeValue);
        priceEl.textContent = '$' + Number(newPrice || 0).toLocaleString('es-AR');
      }

            function addCurrentProductToCart() {
        let colorKey = currentSelectedColor || 'Unico';
        let colorId = null;
        const colorActive = document.querySelector('[data-color-option].is-active, [data-color-option].active, [data-color-option].selected');
        if (colorActive) {
          const datasetColor = colorActive.dataset.colorName || colorActive.dataset.color;
          if (datasetColor) colorKey = String(datasetColor);
          if (colorActive.dataset.variantId) colorId = colorActive.dataset.variantId;
        }
        const colorOption = findColorOption(currentProduct || {}, colorKey);
        if (!colorId && colorOption) {
          const candidateId = colorOption.id ?? colorOption.colorId ?? colorOption.variantId ?? colorOption.variant_id;
          if (candidateId != null) colorId = candidateId;
        }

        let size = currentSelectedSize || 'U';
        const sizeActive = document.querySelector('[data-size-option].is-active, [data-size-option].active, .size-chip.selected');
        if (sizeActive) {
          const datasetSize = sizeActive.dataset.sizeValue || sizeActive.dataset.size;
          if (datasetSize) {
            size = String(datasetSize);
          } else if (currentSelectedSize) {
            size = currentSelectedSize;
          }
        }

        const qty = currentQty || 1;
        const price = getPriceForSize(currentProduct || {}, size || '');
        const displayColor = getDisplayColorName(currentProduct || {}, colorOption?.name || colorKey);
        const image = getColorImage(currentProduct || {}, colorKey);
        const productId = currentProduct && currentProduct.id ? currentProduct.id : slugifyName(currentProduct && currentProduct.name);

        if (window.romixCart && typeof window.romixCart.addToCart === 'function') {
          window.romixCart.addToCart({
            productId,
            name: currentProduct && currentProduct.name ? currentProduct.name : '',
            type: currentProduct && currentProduct.type ? currentProduct.type : '',
            color: displayColor,
            colorName: displayColor,
            colorKey,
            colorId: colorId || null,
            size,
            qty,
            price,
            image
          });
          window.romixCart.updateBadge();
        }

        return { quantity: qty };
      }

      function formatPrice(value){
        return `$${Number(value || 0).toLocaleString('es-AR')}`;
      }

      function parsePreloadedList(){
        try {
          const el = document.getElementById('preloaded-products');
          if (!el) return null;
          const raw = el.textContent || el.innerText || '';
          const parsed = JSON.parse(raw.trim() || '[]');
          return sanitizeList(Array.isArray(parsed) ? parsed : []);
        } catch (error) {
          console.warn('[detalle] preloaded inválido', error);
          return null;
        }
      }

      async function loadProducts(){
        const cached = parsePreloadedList();
        if (cached && cached.length) return cached;
        if (window.romixProductsStore && typeof window.romixProductsStore.load === 'function') {
          return window.romixProductsStore.load({
            preloadedScriptId: 'preloaded-products',
            dataUrl: DATA_URL
          });
        }
        const response = await fetch(new URL(DATA_URL, location.href));
        if (!response.ok) throw new Error('HTTP ' + response.status);
        const json = await response.json();
        return sanitizeList(Array.isArray(json) ? json : []);
      }

      function findProduct(list){
        if (!Array.isArray(list)) return null;
        let product = null;
        if (idParam) {
          product = list.find(item => String(item.id) === idParam);
        }
        if (!product && slugParam) {
          product = list.find(item => slugifyName(item.name || '') === slugParam);
        }
        if (!product && nameParam) {
          const lower = nameParam.toLowerCase();
          product = list.find(item => String(item.name || '').toLowerCase() === lower);
        }
        return product;
      }

      function statusToQty(status){
        const value = String(status || '').toLowerCase();
        if (/out|agot|unavail/.test(value)) return 0;
        if (/low|poco/.test(value)) return 2;
        return 5;
      }

      function buildSizeMap(entry, fallback){
        const result = {};
        const keys = new Set([...(fallback ? Object.keys(fallback) : []), ...(entry ? Object.keys(entry) : [])]);
        keys.forEach(key => {
          const raw = entry && entry[key];
          if (raw != null && raw !== '') {
            result[key] = Number(raw) || 0;
          } else {
            result[key] = (fallback && fallback[key]) ? fallback[key] : 0;
          }
        });
        return result;
      }

      function buildStockMap(product){
        const fallback = {};
        if (Array.isArray(product.sizes)) {
          product.sizes.forEach(size => {
            const key = String(size.size || size).trim() || 'Unico';
            fallback[key] = statusToQty(size.status);
          });
        }
        const map = {};
        if (product.stockByColor && typeof product.stockByColor === 'object') {
          Object.entries(product.stockByColor).forEach(([colorName, data]) => {
            map[colorName] = buildSizeMap(data, fallback);
          });
        }
        let palette = [];
        if (Array.isArray(product.colors) && product.colors.length) {
          palette = product.colors;
        } else if (product.colors && typeof product.colors === 'object') {
          const values = Object.values(product.colors);
          if (values.every(v => v && typeof v === 'object')) {
            palette = values;
          } else if (product.colors.name) {
            palette = [product.colors];
          }
        } else if (Array.isArray(product.designs) && product.designs.length) {
          palette = product.designs;
        } else {
          palette = [{ name: 'Unico' }];
        }
        palette.forEach(color => {
          const key = color.name || 'Unico';
          if (!map[key]) {
            map[key] = { ...fallback };
          }
        });
        if (!Object.keys(map).length) {
          map['Unico'] = { ...fallback };
        }
        return map;
      }

      function getGallery(product){
        const images = [];
        if (product.images && typeof product.images === 'object') {
          Object.keys(product.images).forEach(label => {
            const src = product.images[label];
            if (src) images.push({ label, src });
          });
        }
        if (!images.length && product.image) {
          images.push({ label: 'principal', src: product.image });
        }
        if (!images.length) {
          images.push({ label: 'placeholder', src: PLACEHOLDER });
        }
        return images;
      }

      function getColorImage(product, color){
        const normalizedTarget = normalizeColorKey(color);
        if (product.images && typeof product.images === 'object') {
          if (color && product.images[color]) return product.images[color];
          if (normalizedTarget) {
            const key = Object.keys(product.images).find(name => normalizeColorKey(name) === normalizedTarget);
            if (key) return product.images[key];
          }
          const first = Object.values(product.images)[0];
          if (first) return first;
        }
        const colorOpt = findColorOption(product, color);
        if (colorOpt) {
          if (colorOpt.image) return colorOpt.image;
          if (colorOpt.swatch || colorOpt.preview || colorOpt.pattern) {
            return colorOpt.swatch || colorOpt.preview || colorOpt.pattern;
          }
        }
        if (product.image) return product.image;
        return PLACEHOLDER;
      }

      function getStockLabel(total){
        if (total <= 0) return 'Agotado';
        if (total <= 3) return 'Por agotarse';
        return 'Disponible';
      }

      function inferSeason(name){
        const text = String(name || '').toLowerCase();
        if (/(frizado|frisado|termic|termi|termico|polar|invierno)/.test(text)) return 'Invierno';
        if (/(verano|capri|short|ciclista|musculosa|fibrana|liviano|liviana)/.test(text)) return 'Verano';
        return 'Todo el año';
      }

      function inferMaterial(product){
        const text = String(product.name || '').toLowerCase();
        const materials = [];
        if (/lycra|saplex/.test(text)) materials.push('Lycra');
        if (/algodón/.test(text)) materials.push('Algodón');
        if (/polar/.test(text)) materials.push('Polar');
        if (/morley/.test(text)) materials.push('Morley');
        if (/modal/.test(text)) materials.push('Modal');
        if (/fibrana|fibra/.test(text)) materials.push('Fibrana');
        if (/rústico/.test(text)) materials.push('Rústico');
        if (!materials.length && product.specs && typeof product.specs === 'object') {
          const comp = product.specs['Composición'] || product.specs['Composicion'] || product.specs['Composition'];
          if (comp) {
            return comp;
          }
        }
        if (!materials.length) return 'Consultar etiqueta';
        return materials.join(', ');
      }

      function inferGender(section){
        if (!section) return '';
        const text = String(section).toLowerCase();
        if (/mujer/.test(text)) return 'Mujer';
        if (/hombre/.test(text)) return 'Hombre';
        if (/niños|nino|nia|ninos/.test(text)) return 'Niños';
        return section.charAt(0).toUpperCase() + section.slice(1);
      }

      function inferFit(name){
        const text = String(name || '').toLowerCase();
        const segments = [];
        if (/chupín/.test(text)) segments.push('Chupín (ajustado)');
        if (/jogger/.test(text)) segments.push('Jogger');
        if (/oxford/.test(text)) segments.push('Oxford');
        if (/recto/.test(text)) segments.push('Recto');
        if (/capri/.test(text)) segments.push('Capri');
        if (/ciclista|short/.test(text)) segments.push('Corto / Ciclista');
        return segments.join(', ') || 'Regular';
      }

      function inferElasticity(name){
        const text = String(name || '').toLowerCase();
        if (/lycra|saplex|elast/.test(text)) return 'Alta';
        if (/algodón/.test(text)) return 'Media';
        return 'Media';
      }

      function setupZoomModal(detail, gallery){
        if (!detail) return;
        const mainImage = detail.querySelector('#main-image');
        const modal = detail.querySelector('#zoom-modal');
        const zoomImage = detail.querySelector('#zoom-image');
        const openBtn = detail.querySelector('#zoom-open');
        const closeBtn = detail.querySelector('#zoom-close');
        const stage = detail.querySelector('#zoom-stage');
        const prevBtn = detail.querySelector('#zoom-prev');
        const nextBtn = detail.querySelector('#zoom-next');
        const counterEl = detail.querySelector('#zoom-counter');
        if (!mainImage || !modal || !zoomImage || !openBtn || !closeBtn || !stage || !prevBtn || !nextBtn || !counterEl) return;

        const items = Array.isArray(gallery)
          ? gallery.map(item => item && item.src).filter(Boolean).map(src => {
            try {
              return new URL(src, window.location.href).href;
            } catch {
              return src;
            }
          })
          : [];
        const total = items.length || 1;
        let currentIndex = 0;
        let scale = 1;
        let translateX = 0;
        let translateY = 0;
        let dragging = false;
        let startX = 0;
        let startY = 0;
        let touchStartX = 0;
        let touchStartY = 0;
        let lastTap = 0;
        let lastActive = null;
        let isOpen = false;

        function getFocusable(){
          const nodes = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
          return Array.from(nodes).filter(node => !node.disabled && node.offsetParent !== null);
        }

        function applyTransform(){
          zoomImage.style.transform = 'translate(' + translateX + 'px, ' + translateY + 'px) scale(' + scale + ')';
        }

        function updateZoomState(){
          stage.classList.toggle('is-zoomed', scale > 1);
        }

        function reset(){
          scale = 1;
          translateX = 0;
          translateY = 0;
          applyTransform();
          updateZoomState();
        }

        function syncImage(){
          const src = items[currentIndex] || mainImage.src;
          zoomImage.src = src;
          reset();
          counterEl.textContent = (currentIndex + 1) + ' / ' + total;
          prevBtn.disabled = currentIndex <= 0;
          nextBtn.disabled = currentIndex >= total - 1;
        }

        function open(){
          modal.classList.add('is-open');
          modal.setAttribute('aria-hidden', 'false');
          document.body.style.overflow = 'hidden';
          const src = mainImage.src;
          const idx = items.indexOf(src);
          currentIndex = idx >= 0 ? idx : 0;
          syncImage();
          lastActive = document.activeElement;
          isOpen = true;
          closeBtn.focus();
          document.addEventListener('keydown', onKeydown);
        }

        function close(){
          modal.classList.remove('is-open');
          modal.setAttribute('aria-hidden', 'true');
          dragging = false;
          stage.classList.remove('dragging');
          document.body.style.overflow = '';
          isOpen = false;
          document.removeEventListener('keydown', onKeydown);
          if (lastActive && typeof lastActive.focus === 'function') {
            lastActive.focus();
          }
        }

        function clampScale(value){
          return Math.max(1, Math.min(4, value));
        }

        prevBtn.style.display = total > 1 ? 'block' : 'none';
        nextBtn.style.display = total > 1 ? 'block' : 'none';

        openBtn.addEventListener('click', open);
        mainImage.addEventListener('click', open);
        mainImage.addEventListener('keydown', (evt) => {
          if (evt.key === 'Enter' || evt.key === ' ') {
            evt.preventDefault();
            open();
          }
        });
        closeBtn.addEventListener('click', close);
        modal.addEventListener('click', (evt) => { if (evt.target === modal) close(); });

        prevBtn.addEventListener('click', () => { if (currentIndex > 0){ currentIndex -= 1; syncImage(); } });
        nextBtn.addEventListener('click', () => { if (currentIndex < total - 1){ currentIndex += 1; syncImage(); } });

        stage.addEventListener('mousedown', (evt) => {
          if (scale <= 1) return;
          dragging = true;
          stage.classList.add('dragging');
          startX = evt.clientX - translateX;
          startY = evt.clientY - translateY;
        });

        window.addEventListener('mousemove', (evt) => {
          if (!dragging) return;
          translateX = evt.clientX - startX;
          translateY = evt.clientY - startY;
          applyTransform();
        });

        window.addEventListener('mouseup', () => {
          dragging = false;
          stage.classList.remove('dragging');
        });

        modal.addEventListener('wheel', (evt) => {
          evt.preventDefault();
          const delta = evt.deltaY < 0 ? 0.2 : -0.2;
          scale = clampScale(scale + delta);
          if (scale <= 1) {
            translateX = 0;
            translateY = 0;
          }
          applyTransform();
          updateZoomState();
        }, { passive: false });

        stage.addEventListener('click', (evt) => {
          if (!isOpen || dragging) return;
          if (scale <= 1) {
            scale = clampScale(2);
          } else {
            scale = 1;
            translateX = 0;
            translateY = 0;
          }
          applyTransform();
          updateZoomState();
        });

        stage.addEventListener('touchstart', (evt) => {
          if (!evt.touches || evt.touches.length !== 1) return;
          touchStartX = evt.touches[0].clientX;
          touchStartY = evt.touches[0].clientY;
          const now = Date.now();
          if (now - lastTap < 280){
            scale = clampScale(scale === 1 ? 2 : 1);
            translateX = 0;
            translateY = 0;
            applyTransform();
            updateZoomState();
          }
          lastTap = now;
        }, { passive: true });

        stage.addEventListener('touchend', (evt) => {
          if (!evt.changedTouches || evt.changedTouches.length !== 1) return;
          const dx = evt.changedTouches[0].clientX - touchStartX;
          const dy = evt.changedTouches[0].clientY - touchStartY;
          if (scale === 1 && Math.abs(dx) > 60 && Math.abs(dy) < 40){
            if (dx < 0 && currentIndex < total - 1){ currentIndex += 1; syncImage(); }
            if (dx > 0 && currentIndex > 0){ currentIndex -= 1; syncImage(); }
          }
        }, { passive: true });

        function onKeydown(evt){
          if (!isOpen) return;
          const key = evt.key;
          if (key === 'Escape') {
            evt.preventDefault();
            close();
            return;
          }
          if (key === 'ArrowLeft') {
            if (currentIndex > 0) { currentIndex -= 1; syncImage(); }
            return;
          }
          if (key === 'ArrowRight') {
            if (currentIndex < total - 1) { currentIndex += 1; syncImage(); }
            return;
          }
          if (key === '+' || key === '=') {
            evt.preventDefault();
            scale = clampScale(scale + 0.5);
            applyTransform();
            updateZoomState();
            return;
          }
          if (key === '-' || key === '_') {
            evt.preventDefault();
            scale = clampScale(scale - 0.5);
            if (scale <= 1) {
              translateX = 0;
              translateY = 0;
            }
            applyTransform();
            updateZoomState();
            return;
          }
          if (key === '0') {
            evt.preventDefault();
            reset();
            return;
          }
          if (key === 'Tab') {
            const focusable = getFocusable();
            if (!focusable.length) return;
            const first = focusable[0];
            const last = focusable[focusable.length - 1];
            if (evt.shiftKey && document.activeElement === first) {
              evt.preventDefault();
              last.focus();
            } else if (!evt.shiftKey && document.activeElement === last) {
              evt.preventDefault();
              first.focus();
            }
          }
        }

        if (mainImage.complete) syncImage();
        const observer = new MutationObserver(() => { syncImage(); });
        observer.observe(mainImage, { attributes: true, attributeFilter: ['src'] });
      }

      function gatherFeatureEntries(product){
        const entries = [];
        const seasonLabel = inferSeason(product.name);
        if (seasonLabel && seasonLabel !== 'Verano') {
          entries.push({ label: 'Temporada', value: seasonLabel });
        }
        entries.push({ label: 'Material principal', value: inferMaterial(product) });
        const gender = inferGender(product.section);
        if (gender) entries.push({ label: 'Género', value: gender });
        if (product.type) entries.push({ label: 'Tipo', value: product.type });
        const fit = inferFit(product.name);
        if (fit) entries.push({ label: 'Ajuste / corte', value: fit });
        entries.push({ label: 'Elasticidad', value: inferElasticity(product.name) });
        if (Array.isArray(product.features)) {
          product.features.forEach(item => {
            if (item) entries.push({ label: 'Característica', value: item });
          });
        }
        if (product.specs && typeof product.specs === 'object') {
          Object.keys(product.specs).forEach(key => {
            const val = product.specs[key];
            if (val) entries.push({ label: key, value: val });
          });
        }
        return entries;
      }

      function renderProduct(product){
        const detail = document.getElementById('product-detail');
        if (!detail) return;
        currentProduct = product;
        const gallery = getGallery(product);
        const sectionLabel = product.section ? `${product.section.charAt(0).toUpperCase()}${product.section.slice(1)}` : '';
        const typeLabel = product.type || '';
        const badge = product.badge ? `<span class="meta-pill">${product.badge}</span>` : '';
        detail.innerHTML = `
          <div class="detail-grid">
            <div class="gallery">
              <div class="main-image" role="button" tabindex="0" aria-label="Abrir zoom de imagen" aria-haspopup="dialog">
                <img id="main-image" src="${gallery[0].src}" alt="${product.name || 'Producto'}" onerror="this.onerror=null;this.src='${PLACEHOLDER}';" />
                <button type="button" class="zoom-btn" id="zoom-open" aria-label="Acercar imagen" aria-haspopup="dialog">
                  <i class="fas fa-search-plus" aria-hidden="true"></i>
                </button>
              </div>
              ${gallery.length > 1 ? `<div class="thumbs" id="gallery-thumbs">${gallery.map((image, index) => `<img src="${image.src}" alt="${image.label || product.name}" data-index="${index}" data-color="${image.label || ''}" ${index === 0 ? 'class="active"' : ''} loading="lazy"/>`).join('')}</div>` : ''}
            </div>
            <div class="info-panel">
              <div>
                <div class="title-row">
                  <h1>${product.name || 'Producto'}</h1>
                  ${badge}
                </div>
                <div class="meta-pills">
                  ${sectionLabel ? `<span class="meta-pill">${sectionLabel}</span>` : ''}
                  ${typeLabel ? `<span class="meta-pill">${typeLabel}</span>` : ''}
                </div>
              </div>
              <div class="price-area">
                <span id="product-price" class="current-price">${formatPrice(product.price)}</span>
                ${product.originalPrice ? `<span class="original-price">${formatPrice(product.originalPrice)}</span>` : ''}
              </div>
              <div class="stock-note" id="stock-note"></div>
              ${product.description ? `<p class="detail-description">${product.description}</p>` : ''}
              <div class="selector">
                <div class="selector-label">Color</div>
                <div id="colorPicker" class="color-picker" aria-label="Selector de color">
                  <p class="color-picker-label" aria-live="polite"><span id="selectedColorName"></span></p>
                  <div class="color-options swatches" id="color-options" role="radiogroup" aria-label="Seleccionar color"></div>
                </div>
                <div id="color-stock-info" class="stock-info-color"></div>
              </div>
              <div class="selector">
                <div class="selector-label">Talle</div>
                <div class="size-options" id="size-options"></div>
              </div>
              <div class="selector quantity-row">
                <div class="selector-label">Cantidad</div>
                <div class="qty-control">
                  <button type="button" id="quantity-minus" aria-label="Disminuir cantidad">-</button>
                  <input id="quantity-input" type="number" min="1" value="1" />
                  <button type="button" id="quantity-plus" aria-label="Aumentar cantidad">+</button>
                </div>
              </div>
              <div class="purchase-actions" id="purchase-actions">
                <button id="btn-buy" class="btn primary" type="button">Comprar</button>
                <button id="btn-add" class="btn outline" type="button">Agregar al carrito</button>
              </div>
            </div>
          </div>
          <div class="zoom-modal" id="zoom-modal" aria-hidden="true">
            <div class="zoom-panel" role="dialog" aria-modal="true" aria-label="Zoom de producto" aria-describedby="zoom-help" tabindex="-1">
              <p class="sr-only" id="zoom-help">Hace click sobre la imagen para acercar o alejar. Usa las flechas para cambiar de imagen. Usa mas y menos para acercar o alejar. Presiona Escape para cerrar.</p>
              <div class="zoom-counter" id="zoom-counter" aria-live="polite">1 / 1</div>
              <button type="button" class="zoom-close" id="zoom-close" aria-label="Cerrar">x</button>
              <button type="button" class="zoom-nav prev" id="zoom-prev" aria-label="Anterior">&lt;</button>
              <div class="zoom-stage" id="zoom-stage" tabindex="0" aria-label="Imagen ampliada">
                <img id="zoom-image" src="${gallery[0].src}" alt="${product.name || 'Producto'}" />
              </div>
              <button type="button" class="zoom-nav next" id="zoom-next" aria-label="Siguiente">&gt;</button>
            </div>
          </div>
          `;
        document.title = product.name ? `ROMIX - ${product.name}` : 'ROMIX - Detalle';

        const mainImage = detail.querySelector('#main-image');
        const thumbContainer = detail.querySelector('#gallery-thumbs');
        const colorPickerContainer = detail.querySelector('#colorPicker');
        const swatchWrapper = detail.querySelector('#color-options');
        const selectedColorNameEl = detail.querySelector('#selectedColorName');
        const sizeWrapper = detail.querySelector('#size-options');
        const stockNote = detail.querySelector('#stock-note');
        const quantityInput = detail.querySelector('#quantity-input');
        const minusBtn = detail.querySelector('#quantity-minus');
        const plusBtn = detail.querySelector('#quantity-plus');
        const purchaseActions = detail.querySelector('#purchase-actions');
        const btnAdd = detail.querySelector('#btn-add');
        const btnBuy = detail.querySelector('#btn-buy');
        let colorPickerApi = null;
        setupZoomModal(detail, gallery);

        const canonicalColor = (value) => {
          const raw = (value || '').toString().trim();
          try {
            return raw.normalize('NFD').replace(/\p{Diacritic}+/gu, '').toLowerCase();
          } catch {
            return raw.toLowerCase();
          }
        };
        let palette = [];
        if (Array.isArray(product.colors) && product.colors.length) {
          palette = [...product.colors];
        } else if (product.colors && typeof product.colors === 'object') {
          const values = Object.values(product.colors);
          if (values.every(v => v && typeof v === 'object')) {
            palette = values;
          } else if (product.colors.name || product.colors.hex || product.colors.value) {
            palette = [product.colors];
          }
        } else if (Array.isArray(product.designs) && product.designs.length) {
          palette = product.designs.map(design => ({
            name: design.name,
            hex: design.hex || '#777',
            swatch: design.swatch || design.preview || design.thumb || design.thumbnail || design.image,
            image: design.image,
            variantId: design.variantId || design.id || null
          }));
        } else if (product.stockByColor && typeof product.stockByColor === 'object' && Object.keys(product.stockByColor).length) {
          palette = Object.keys(product.stockByColor).map(name => ({ name }));
        } else {
          palette = [{ name: 'Unico', hex: '#555' }];
        }
        const stockColors = (product.stockByColor && typeof product.stockByColor === 'object') ? Object.keys(product.stockByColor) : [];
        stockColors.forEach(colorName => {
          const exists = palette.some(entry => canonicalColor(entry && (entry.name || entry.value)) === canonicalColor(colorName));
          if (!exists) palette.push({ name: colorName });
        });
        let defaultColorName = (palette[0].name || palette[0].hex || palette[0].value || 'Unico');
        if (colorParam) {
          const targetKey = normalizeColorKey(colorParam);
          const matched = palette.find(entry => normalizeColorKey(entry && (entry.name || entry.value || '')) === targetKey);
          if (matched) defaultColorName = matched.name || matched.value || defaultColorName;
        } else if (variantParam) {
          const matched = palette.find(entry => String(entry.variantId || entry.variant_id || entry.id || '') === String(variantParam));
          if (matched) defaultColorName = matched.name || matched.value || defaultColorName;
        }
        currentSelectedColor = defaultColorName;
        const stockMap = buildStockMap(product);
        const stockTotals = Object.values(stockMap || {}).map(map => Object.values(map || {}).reduce((acc, qty) => acc + (Number(qty) || 0), 0));
        const derivedStock = currentProduct && currentProduct.stock ? Number(currentProduct.stock) : 0;
        if (derivedStock && !Number.isNaN(derivedStock)) {
          STOCK_MAX = derivedStock;
        } else if (stockTotals.length) {
          const maxFromMap = Math.max(...stockTotals);
          if (maxFromMap && !Number.isNaN(maxFromMap)) {
            STOCK_MAX = maxFromMap;
          }
        } else {
          STOCK_MAX = STOCK_MAX || 10;
        }
        const sizeOrder = Array.isArray(product.sizes) ? product.sizes.map(size => String(size.size || size)).filter(Boolean) : [];
        let activeColor = defaultColorName;
        let activeSize = '';

        if (thumbContainer) {
          const thumbs = Array.from(thumbContainer.querySelectorAll('img'));
          thumbs.forEach((thumb, index) => {
            thumb.addEventListener('click', () => {
              thumbs.forEach(el => el.classList.remove('active'));
              thumb.classList.add('active');
              const targetColor = thumb.dataset.color || '';
              if (targetColor && findColorOption(product, targetColor)) {
                setActiveColor(targetColor, { imageOverride: gallery[index].src, skipThumbSync: true });
              } else if (mainImage) {
                mainImage.src = gallery[index].src;
              }
            });
          });
        }

        function renderSizesForColor(colorName){
          if (!sizeWrapper) return;
          const map = stockMap[colorName] || stockMap['Unico'] || {};
          let keys = sizeOrder.length ? [...new Set([...sizeOrder, ...Object.keys(map)])] : Object.keys(map);
          if (!keys.length) keys.push('Unico');
          sizeWrapper.innerHTML = '';
          let total = 0;
          let firstAvailable = null;
          keys.forEach(sizeKey => {
            const qty = Number(map[sizeKey] ?? 0);
            total += qty;
            const state = qty <= 0 ? 'out' : (qty <= 3 ? 'low' : 'available');
            const chip = document.createElement('button');
            chip.type = 'button';
            chip.className = 'size-chip size-option';
            chip.dataset.state = state;
            chip.dataset.size = sizeKey;
            chip.dataset.sizeOption = 'true';
            chip.dataset.sizeValue = sizeKey;
            chip.textContent = sizeKey;
            if (state === 'out') chip.classList.add('out');
            chip.addEventListener('click', () => {
              if (state === 'out') return;
              sizeWrapper.querySelectorAll('.size-chip').forEach(el => el.classList.remove('selected', 'is-active', 'size-option--active'));
              chip.classList.add('selected', 'is-active', 'size-option--active');
              activeSize = sizeKey;
              currentSelectedSize = sizeKey;
              updatePriceForSize(product, activeSize);
            });
            sizeWrapper.appendChild(chip);
            if (!firstAvailable && state !== 'out') firstAvailable = sizeKey;
          });
          if (!activeSize || !sizeWrapper.querySelector(`.size-chip[data-size="${activeSize}"]`)) {
            const fallback = sizeWrapper.querySelector('.size-chip:not(.out)');
            if (fallback) {
              fallback.classList.add('selected', 'is-active', 'size-option--active');
              activeSize = fallback.dataset.size;
            } else if (sizeWrapper.firstChild) {
              sizeWrapper.firstChild.classList.add('selected', 'is-active', 'size-option--active');
              activeSize = sizeWrapper.firstChild.dataset.size;
            }
          }
          currentSelectedSize = activeSize || currentSelectedSize || '';
          const label = getStockLabel(total);
          if (stockNote) {
            stockNote.textContent = label;
            stockNote.style.display = 'block';
          }
          const fallbackMax = Number(currentProduct && currentProduct.stock) || 0;
          const nextMax = fallbackMax > 0 ? fallbackMax : (total > 0 ? total : STOCK_MAX);
          STOCK_MAX = nextMax > 0 ? nextMax : 10;
          currentQty = Math.min(currentQty, STOCK_MAX);
          setQuantity(currentQty);
        }

        function getVariantStock(product, colorName, sizeValue) {
          const map = stockMap[colorName] || stockMap['Unico'] || {};
          const qty = map[sizeValue] != null ? Number(map[sizeValue]) : null;
          if (qty != null) return qty;
          if (product && Array.isArray(product.variants)) {
            const match = product.variants.find(v =>
              String(v.color).toLowerCase() === String(colorName).toLowerCase() &&
              String(v.size) === String(sizeValue)
            );
            if (match) return Number(match.stock || 0);
          }
          return 0;
        }

        function getColorTotalStock(product, colorName) {
          if (product && Array.isArray(product.variants)) {
            return product.variants.reduce((sum, v) => {
              if (String(v.color).toLowerCase() === String(colorName).toLowerCase()) {
                return sum + Number(v.stock || 0);
              }
              return sum;
            }, 0);
          }
          const map = stockMap[colorName] || stockMap['Unico'] || {};
          return Object.values(map).reduce((acc, qty) => acc + (Number(qty) || 0), 0);
        }

        function updateSizesStateForColor(product, colorName){
          const sizeButtons = document.querySelectorAll('.size-option');
          if (!sizeButtons.length) return;

          sizeButtons.forEach(btn => {
            const sizeVal = btn.dataset.sizeValue;
            const stock = getVariantStock(product, colorName, sizeVal);

            btn.classList.remove('size-option--available', 'size-option--low', 'size-option--out');
            btn.disabled = false;

            if (stock <= 0) {
              btn.classList.add('size-option--out');
              btn.disabled = true;
            } else if (stock <= 3) {
              btn.classList.add('size-option--low');
            } else {
              btn.classList.add('size-option--available');
            }
          });

          const infoEl = document.getElementById('color-stock-info');
          if (infoEl) {
            infoEl.textContent = '';
            infoEl.style.display = 'none';
          }

          const detailEl = document.getElementById('stock-detail');
          if (detailEl) {
            detailEl.textContent = '';
            detailEl.style.display = 'none';
          }
        }

        function updatePriceForSize(product, sizeValue){
          const priceEl = document.getElementById('product-price');
          if (!priceEl) return;
          const newPrice = getPriceForSize(product, sizeValue);
          priceEl.textContent = '$' + Number(newPrice || 0).toLocaleString('es-AR');
        }

        function setActiveColor(colorName, options = {}){
          const opts = options || {};
          activeColor = colorName;
          currentSelectedColor = colorName;

          if (!opts.skipPickerSync && colorPickerApi) {
            colorPickerApi.selectColor(colorName, { silent: true });
          } else if (swatchWrapper) {
            const targetName = String(colorName || '').toLowerCase();
            swatchWrapper.querySelectorAll('.color-swatch').forEach(btn => {
              const btnName = (btn.dataset.colorName || btn.dataset.color || '').toString().toLowerCase();
              const match = btnName === targetName;
              btn.classList.toggle('active', match);
              btn.classList.toggle('selected', match);
              btn.classList.toggle('is-active', match);
              btn.setAttribute('aria-pressed', match ? 'true' : 'false');
            });
          }

          if (selectedColorNameEl && !opts.skipLabelUpdate) {
            const activeSwatch = swatchWrapper ? swatchWrapper.querySelector('.color-swatch.active') : null;
            const fallbackName = activeSwatch ? (activeSwatch.dataset.colorHex || activeSwatch.dataset.colorName || '') : '';
            const displayName = getDisplayColorName(product, colorName || fallbackName);
            selectedColorNameEl.textContent = displayName || fallbackName || '';
          }
          if (mainImage) {
            let imageOverride = opts.imageOverride;
            if (!imageOverride && swatchWrapper) {
              const targetKey = normalizeColorKey(colorName);
              const matchedSwatch = Array.from(swatchWrapper.querySelectorAll('.color-swatch'))
                .find(btn => normalizeColorKey(btn.dataset.colorName || btn.dataset.color || '') === targetKey);
              if (matchedSwatch && matchedSwatch.dataset.colorImage) {
                imageOverride = matchedSwatch.dataset.colorImage;
              }
            }
            mainImage.src = imageOverride || getColorImage(product, colorName);
          }
          if (thumbContainer && !opts.skipThumbSync) {
            const targetKey = normalizeColorKey(colorName);
            thumbContainer.querySelectorAll('img').forEach(thumb => {
              const thumbKey = normalizeColorKey(thumb.dataset.color || '');
              const match = targetKey && thumbKey && thumbKey === targetKey;
              thumb.classList.toggle('active', match);
            });
          }
          renderSizesForColor(colorName);
          updateSizesStateForColor(product, colorName);
          if (activeSize) updatePriceForSize(product, activeSize);
        }

        if (swatchWrapper) {
          swatchWrapper.innerHTML = '';
          palette.forEach((color, index) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'color-swatch color-option';
            const colorName = color.name || `color-${index + 1}`;
            const colorHex = color.hex || color.value || '#000';
            const colorSwatchImage = color.swatch || color.preview || color.pattern || color.thumb || color.thumbnail || color.image || (product.images && product.images[colorName]) || '';
            btn.dataset.color = colorName;
            btn.dataset.colorOption = 'true';
            btn.dataset.colorName = colorName;
            btn.dataset.colorHex = colorHex;
            if (colorSwatchImage) {
              btn.dataset.colorImage = colorSwatchImage;
              btn.classList.add('has-image');
              btn.style.backgroundImage = `url('${colorSwatchImage}')`;
            }
            const variantId = color.variantId || color.variant_id || color.id;
            if (variantId) btn.dataset.variantId = variantId;
            btn.style.setProperty('--color-value', colorHex);
            btn.setAttribute('aria-label', `Elegir color ${colorName}`);
            btn.title = colorName;
            btn.setAttribute('aria-pressed', 'false');
            swatchWrapper.appendChild(btn);
          });
        }

        if (colorPickerContainer) {
          colorPickerContainer.addEventListener('colorChange', (event) => {
            const selectedName = event?.detail?.name;
            if (!selectedName) return;
            if (selectedName !== activeColor) {
              setActiveColor(selectedName, { skipPickerSync: true });
            }
          });
          colorPickerApi = initColorPicker(colorPickerContainer, selectedColorNameEl, '.color-swatch');
        }

        setActiveColor(defaultColorName);

        if (btnAdd) {
          btnAdd.addEventListener('click', () => {
            addCurrentProductToCart();
            showToast('Se agregó con éxito al carrito');
          });
        }

        if (btnBuy) {
          btnBuy.addEventListener('click', () => {
            addCurrentProductToCart();
            showToast('Se agregó con éxito al carrito');
            window.location.href = 'cart.html';
          });
        }
        minusBtn?.addEventListener('click', () => setQuantity(currentQty - 1));
        plusBtn?.addEventListener('click', () => setQuantity(currentQty + 1));

        quantityInput?.addEventListener('change', () => setQuantity(quantityInput.value));

        setQuantity(1);

      }

      function renderFeatures(product){
        const section = document.getElementById('features-section');
        const grid = document.getElementById('features-grid');
        if (!section || !grid) return;
        const entries = gatherFeatureEntries(product);
        if (!entries.length) {
          section.hidden = true;
          return;
        }
        grid.innerHTML = entries.map(entry => `
          <article class="feature-card">
            <strong>${entry.label}:</strong>
            <span>${entry.value}</span>
          </article>`).join('');
        section.hidden = false;
      }

    function renderRelated(list, product){
      // deprecated placeholder (legacy)
    }

    function renderRelatedProducts(allProducts, currentProduct) {
      const container = document.getElementById('related-grid');
      if (!container || !Array.isArray(allProducts) || !currentProduct) return;

      const relatedRaw = allProducts.filter(p => {
        if (!p) return false;
        if (currentProduct.id && p.id === currentProduct.id) return false;

        const sameSection = p.section && currentProduct.section &&
          String(p.section).toLowerCase() === String(currentProduct.section).toLowerCase();

        const sameType = p.type && currentProduct.type &&
          String(p.type).toLowerCase() === String(currentProduct.type).toLowerCase();

        return sameSection || sameType;
      });

      if (!relatedRaw.length) {
        container.innerHTML = '<p style="color:#6c757d;font-size:.9rem;">No hay recomendaciones disponibles.</p>';
        return;
      }

      const related = relatedRaw
        .slice()
        .sort(() => Math.random() - 0.5)
        .slice(0, 8);

      container.innerHTML = '';

      related.forEach(p => {
        const card = document.createElement('article');
        card.className = 'related-card';
        card.setAttribute('aria-label', p.name || 'Producto relacionado');

        const pid = p.id || p.slug || p.name || '';
        card.addEventListener('click', () => {
          const href = typeof buildHref === 'function' ? buildHref(p) : null;
          if (href) {
            window.location.href = href;
          } else {
            console.warn('[detalle][relacionados] producto sin id/slug válido, no navego', p);
          }
        });

        const thumb = document.createElement('div');
        thumb.className = 'related-card-thumb';

        const img = document.createElement('img');
        img.src = p.image || (p.images ? Object.values(p.images)[0] : '');
        img.alt = p.name || '';
        thumb.appendChild(img);

        const name = document.createElement('div');
        name.className = 'related-card-name';
        name.textContent = p.name || 'Producto';

        const price = document.createElement('div');
        price.className = 'related-card-price';
        price.textContent = '$' + Number(p.price || 0).toLocaleString('es-AR');

        const meta = document.createElement('div');
        meta.className = 'related-card-meta';
        const typeText = p.type ? String(p.type) : '';
        const sectionText = p.section ? String(p.section) : '';
        meta.textContent = [sectionText, typeText].filter(Boolean).join(' | ');

        card.appendChild(thumb);
        card.appendChild(name);
        card.appendChild(price);
        card.appendChild(meta);

        container.appendChild(card);
      });
    }

      function showNotFound(){
        const detail = document.getElementById('product-detail');
        if (detail) detail.innerHTML = '<p>No se encontró el producto.</p>';
        document.getElementById('features-section')?.setAttribute('hidden', 'hidden');
        console.warn('[detalle] No se encontró el producto con', { idParam, slugParam, nameParam });
      }

      async function init(){
        updateCartCount();
        try {
          const list = await loadProducts();
          const product = findProduct(list);
          if (!product) {
            showNotFound();
            return;
          }
          renderProduct(product);
          renderFeatures(product);
          renderRelatedProducts(list, product);
          if (buyParam === '1') {
            setTimeout(() => {
              const target = document.getElementById('purchase-actions');
              if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 250);
          }
        } catch (error) {
          console.error('[detalle] Error al cargar productos', error);
          const detail = document.getElementById('product-detail');
          if (detail) detail.innerHTML = '<p>Error al cargar el producto. Intenta recargar la página.</p>';
        }
      }

      window.addEventListener('DOMContentLoaded', init);
    })();
  </script>
  <script src="assets/js/search.js"></script>
  <div id="romix-toast" class="romix-toast" aria-live="polite" role="status"></div>
  <script src="assets/js/romix-header.js"></script>
</body>
</html>








