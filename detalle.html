<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ROMIX - Detalle</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <style>
    :root { --primary:#e83e8c; --secondary:#6f42c1; --success:#28a745; --danger:#dc3545; --muted:#6c757d; }
    * { box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { margin:0; background:#fff1f6; color:#232323; }
    header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color:#fff; padding:14px 0; box-shadow:0 4px 14px rgba(0,0,0,.12); }
    .header-wrap { max-width:1200px; margin:0 auto; padding:0 20px; display:flex; align-items:center; justify-content:space-between; }
    .logo { font-size:1.4rem; font-weight:900; display:flex; align-items:center; gap:8px; }
    .cart-btn { display:inline-flex; align-items:center; gap:6px; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.5); color:#fff; padding:8px 12px; border-radius:999px; cursor:pointer; }
    #cart-count { background: var(--danger); color:#fff; border-radius:999px; padding:0 6px; font-size:.8rem; }

    .container { max-width:1200px; margin:20px auto; padding:0 20px; }
    .card { background:#fff; border-radius:16px; padding:20px; box-shadow:0 14px 36px rgba(0,0,0,.10); }
    .detail { display:grid; grid-template-columns: 1.2fr 1fr; gap:24px; }
    .thumb { background:#fff; border-radius:12px; display:flex; align-items:center; justify-content:center; min-height:420px; }
    .thumb img { max-width:100%; max-height:100%; object-fit:contain; }
    .title { font-size:2rem; font-weight:900; margin:6px 0 10px; color:#1b1f24; }
    .price { font-size:1.8rem; color:var(--primary); font-weight:900; margin-bottom:8px; }
    .pill { display:inline-flex; align-items:center; gap:6px; background:#e9f7ef; color:#207a3a; border:1px solid #ccebd8; padding:6px 10px; border-radius:999px; font-weight:800; }
    .muted { color: var(--muted); }
    .section { margin-top:16px; }
    .qty-row { display:flex; align-items:center; gap:10px; margin:12px 0; }
    .qty-btn { width:36px; height:36px; border-radius:8px; border:1px solid #dee2e6; background:#fff; font-weight:900; cursor:pointer; }
    .qty-input { width:64px; height:36px; border:1px solid #dee2e6; border-radius:8px; text-align:center; }
    .max-note { color:#6c757d; font-weight:700; }
    .cta { display:block; width:100%; padding:14px 16px; border-radius:10px; border:none; background: linear-gradient(135deg, var(--primary), var(--secondary)); color:#fff; font-weight:900; cursor:pointer; margin-top:6px; }
    .cta:disabled { filter: grayscale(1); opacity:.6; cursor:not-allowed; }
    hr { border:none; border-top:1px solid #eee; margin:18px 0; }
    .policy li { margin:6px 0; color:#495057; }
    @media (max-width: 980px){ .detail{ grid-template-columns:1fr; } .thumb{ min-height:300px; } }
  </style>
  <script>
    const PLACEHOLDER = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`\
      <svg xmlns="http://www.w3.org/2000/svg" width="1000" height="700">\
        <rect width="100%" height="100%" fill="#f8f9fb"/>\
        <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#adb5bd" font-family="Segoe UI, sans-serif" font-size="28">Imagen no disponible</text>\
      </svg>`);

    function slugify(s){ try { return (s||'').normalize('NFD').replace(/\p{Diacritic}+/gu,'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); } catch { return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); } }
    function estimateStock(p){
      try{
        if (typeof p.stock === 'number') return Math.max(0, p.stock);
        const sizes = Array.isArray(p.sizes)?p.sizes:[];
        const perSize = sizes.reduce((t, s)=>{ const st=String(s.status||'').toLowerCase(); if(st.includes('out')||st.includes('unavail')) return t; if(st.includes('low')) return t+2; return t+5; },0);
        const colors = Array.isArray(p.colors)&&p.colors.length? p.colors.length : (p.images ? Object.keys(p.images).length : 1);
        return perSize * Math.max(1, colors);
      }catch{ return 0; }
    }
    function safeGetCart(){ try{ return JSON.parse(localStorage.getItem('cart')||'[]'); }catch{ return []; } }
    function safeSetCart(v){ try{ localStorage.setItem('cart', JSON.stringify(v)); }catch{} }
    function updateCartCount(){ const c=safeGetCart(); const n=c.reduce((t,i)=>t+(i.quantity||0),0); const el=document.getElementById('cart-count'); if(el) el.textContent=String(n); }

    function render(p){
      const root = document.getElementById('root'); if(!p||!root){ root.innerHTML = '<p>No se encontró el producto.</p>'; return; }
      const img = p.image || (p.images && (p.images['Negro'] || Object.values(p.images)[0])) || PLACEHOLDER;
      const price = Number(p.price||0);
      const stock = estimateStock(p);
      const badge = p.type ? `<span class="muted" style="background:#f1f3f5;border-radius:999px;padding:6px 10px;font-weight:800;">${p.type}</span>` : '';
      root.innerHTML = `
        <div class="card detail">
          <div class="thumb"><img src="${img}" alt="${p.name}" onerror="this.onerror=null;this.src='${PLACEHOLDER}';"/></div>
          <div>
            <div style="margin-bottom:6px;">${badge}</div>
            <div class="title">${p.name}</div>
            <div class="price">$${price.toLocaleString('es-AR')}</div>
            <div class="pill"><i class="fas fa-check-circle" aria-hidden="true"></i> Disponible - <span id="units">${stock}</span> unidades</div>
            <div class="section">
              <div style="font-weight:800;margin-bottom:6px;color:#1b1f24">Descripción</div>
              <div class="muted">${p.description || p.desc || p.subtitle || p.type || ''}</div>
            </div>
            <div class="section">
              <div style="font-weight:800;margin-bottom:6px;color:#1b1f24">Cantidad</div>
              <div class="qty-row">
                <button id="dec" type="button" class="qty-btn" aria-label="Disminuir">−</button>
                <input id="qty" class="qty-input" type="number" min="1" value="1" />
                <button id="inc" type="button" class="qty-btn" aria-label="Aumentar">+</button>
                <span class="max-note">Máximo disponible: <span id="max">${stock}</span></span>
              </div>
              <button id="add" class="cta"><i class="fas fa-shopping-cart" aria-hidden="true"></i> <span id="btnText">Agregar al Carrito - $${price.toLocaleString('es-AR')}</span></button>
            </div>
            <hr />
            <div class="section">
              <div style="font-weight:800;margin-bottom:6px;color:#1b1f24">Políticas de Devolución</div>
              <ul class="policy">
                <li>Devoluciones aceptadas dentro de 7 días</li>
                <li>Productos en perfecto estado</li>
                <li>Garantía de 5 días en flores frescas</li>
                <li>Garantía de 30 días en floreros</li>
              </ul>
            </div>
          </div>
        </div>`;

      const qty = document.getElementById('qty');
      const dec = document.getElementById('dec');
      const inc = document.getElementById('inc');
      const add = document.getElementById('add');
      const btnText = document.getElementById('btnText');
      const unitsEl = document.getElementById('units');
      const maxEl = document.getElementById('max');
      const max = Math.max(0, stock);
      const updateButton = ()=>{ const q = Math.max(1, Math.min(parseInt(qty.value)||1, max)); qty.value = q; btnText.textContent = `Agregar al Carrito - $${(price*q).toLocaleString('es-AR')}`; add.disabled = max<=0; };
      dec.addEventListener('click', ()=>{ qty.value = Math.max(1, (parseInt(qty.value)||1) - 1); updateButton(); });
      inc.addEventListener('click', ()=>{ qty.value = Math.min(max, (parseInt(qty.value)||1) + 1); updateButton(); });
      qty.addEventListener('input', updateButton);
      updateButton();
      add.addEventListener('click', ()=>{
        const q = Math.max(1, Math.min(parseInt(qty.value)||1, max));
        const cart = safeGetCart();
        const color = (p.colors && p.colors[0] && p.colors[0].name) || 'Único';
        const size = (Array.isArray(p.sizes) && p.sizes[0] && p.sizes[0].size) ? String(p.sizes[0].size) : 'U';
        cart.push({ id: Date.now(), name: p.name, type: p.type || '', color, size, quantity: q, price, subtotal: price*q });
        safeSetCart(cart);
        updateCartCount();
        alert('¡Listo! Se agregó al carrito.');
      });
    }

    async function init(){
      updateCartCount();
      const params = new URLSearchParams(location.search);
      const slug = params.get('slug') || '';
      try{
        const res = await fetch('products.json');
        const list = await res.json();
        const p = (list||[]).find(x=> slug && slugify(x.name||'')===slug) || list[0];
        render(p);
      }catch(e){ document.getElementById('root').innerHTML='<p>Error al cargar el producto.</p>'; }
    }
    window.addEventListener('DOMContentLoaded', init);
  </script>
</head>
<body>
  <header>
    <div class="header-wrap">
      <a href="index.html" class="logo" style="color:#fff;text-decoration:none"><i class="fas fa-store" aria-hidden="true"></i> ROMIX</a>
      <button class="cart-btn" type="button" onclick="alert('Finalizá la compra desde el carrito de la página principal.');">
        <i class="fas fa-shopping-cart" aria-hidden="true"></i>
        Carrito <span id="cart-count">0</span>
      </button>
    </div>
  </header>

  <main class="container">
    <div id="root"></div>
  </main>
</body>
</html>
