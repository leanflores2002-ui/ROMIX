<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ROMIX - Novedades</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <style>
    :root { --primary:#e83e8c; --secondary:#6f42c1; --success:#28a745; --danger:#dc3545; --light:#f8f9fa; --dark:#343a40; }
    html { width:100%; }
    * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; min-width:0; }
    body { margin:0; background:#f5f5f5; color:#232323; }
    main { min-height: calc(100vh - 240px); }
    header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color:#fff; padding:14px 0 10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
    .header-container { max-width:1600px; margin:0 auto; padding:0 28px; display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:16px; }
    .logo { font-size:1.8rem; font-weight:800; display:flex; align-items:center; gap:10px; text-decoration:none; color:#fff; letter-spacing:-0.5px; }
    .logo .logo-mark { width:40px; height:40px; object-fit:contain; display:block; }
    .global-search { display:flex; align-items:center; gap:0; position:relative; max-width:740px; width:100%; margin:0 auto; }
    .global-search input[type="search"] { padding:10px 14px; border:1px solid rgba(255,255,255,.45); border-radius:999px 0 0 999px; min-width:320px; color:#111; background:#fff; caret-color: var(--secondary); width:100%; }
    .global-search input[type="search"]::placeholder { color:#6c757d; }
    .global-search input[type="search"]::selection { background:#ffe0f0; color:#111; }
    .global-search button { padding:10px 16px; border-radius:0 999px 999px 0; border:1px solid rgba(255,255,255,.45); background:#fff; color:var(--primary); cursor:pointer; font-weight:800; }
    .topbar-icons { display:flex; align-items:center; gap:12px; }
    .icon-btn { width:36px; height:36px; border-radius:50%; border:1px solid rgba(255,255,255,.35); background:rgba(255,255,255,.08); color:#fff; display:inline-flex; align-items:center; justify-content:center; text-decoration:none; position:relative; }
    .icon-badge { position:absolute; top:-6px; right:-6px; background:var(--danger); color:#fff; border-radius:999px; font-size:.7rem; padding:2px 6px; }
    .nav-secondary { max-width:1600px; margin:8px auto 0; padding:0 28px 10px; display:flex; gap:14px; align-items:center; flex-wrap:nowrap; overflow-x:auto; color:#fff; font-weight:700; scrollbar-width:none; }
    .nav-secondary a { color:#fff; text-decoration:none; padding:10px 12px; border-radius:12px; transition:background .2s ease, color .2s ease; }
    .nav-secondary a:hover { background:rgba(255,255,255,.12); }
    .cat-pill { background:rgba(255,255,255,.16); color:#fff; border:1px solid rgba(255,255,255,.35); padding:8px 12px; border-radius:999px; font-weight:700; text-decoration:none; font-size:.95rem; }

    .container { max-width:1600px; margin:22px auto; padding:0 28px; }
    .layout { display:grid; grid-template-columns:240px 1fr; gap:18px; align-items:start; }
    .summary { color:#6c757d; margin-left:auto; font-weight:600; }
    .toolbar { display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    .toolbar input[type="search"]{ padding:9px 12px; border:1px solid #dee2e6; border-radius:10px; min-width:240px; color:#212529; background:#fff; caret-color: var(--secondary); }
    .toolbar input[type="search"]::placeholder{ color:#6c757d; }
    .toolbar select{ padding:9px 12px; border:1px solid #dee2e6; border-radius:10px; }
    .filters-toggle { display:none; align-items:center; gap:8px; padding:9px 12px; border:1px solid #dee2e6; border-radius:10px; background:#fff; cursor:pointer; font-weight:700; transition:box-shadow .2s ease, border .2s ease; }
    .filters-toggle:focus-visible { outline:2px solid var(--primary); outline-offset:2px; box-shadow:0 0 0 3px rgba(232,62,140,.25); }

    .filters-panel { background:#fff; border:1px solid #eceff1; border-radius:12px; padding:16px; position:sticky; top:110px; max-height:calc(100vh - 140px); overflow-y:auto; overflow-x:hidden; display:flex; flex-direction:column; gap:14px; box-shadow:0 4px 14px rgba(0,0,0,0.04); transition:transform .32s ease, opacity .32s ease; will-change:transform, opacity; scrollbar-width:thin; scrollbar-color:rgba(0,0,0,.25) transparent; }
    .filters-panel::-webkit-scrollbar { width:6px; }
    .filters-panel::-webkit-scrollbar-track { background:transparent; }
    .filters-panel::-webkit-scrollbar-thumb { background:rgba(0,0,0,.22); border-radius:4px; }
    .filters-panel fieldset { border:none; margin:0; padding:0; }
    .filters-panel legend { margin:0 0 8px; font-size:.95rem; font-weight:700; letter-spacing:.04em; text-transform:uppercase; color:#111; }
    .filters-header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .filters-header-actions { display:flex; gap:8px; align-items:center; margin-left:auto; }
    .filters-title { font-weight:800; font-size:1rem; color:#111; }
    .filters-subtitle { display:block; color:#6c757d; font-size:.85rem; margin-top:2px; }
    .filters-clear { border:none; background:#f1f3f5; color:#495057; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:700; }
    .filters-body { display:flex; flex-direction:column; gap:16px; padding-right:4px; margin:0; min-height:0; }
    .filters-group { padding:10px 8px; border-bottom:1px solid #f1f3f5; }
    .filters-group:last-child { border-bottom:none; }
    .filters-group legend { margin:0 0 8px; font-size:.95rem; color:#111; }
    .filters-options { display:grid; grid-template-columns:1fr; gap:10px; }
    .filter-item { display:flex; align-items:center; gap:10px; font-size:.96rem; color:#343a40; padding:10px 12px; border-radius:12px; background:#fff; border:1px solid #e7ecf5; cursor:pointer; transition:border .2s ease, box-shadow .2s ease, background .2s ease; min-height:48px; }
    .filter-item input { width:20px; height:20px; accent-color: var(--primary); flex-shrink:0; }
    .filter-item:hover,
    .filter-item:focus-within { border-color:var(--primary); box-shadow:0 8px 20px rgba(232,62,140,.12); background:#fff; }
    .filter-item span:last-child { flex:1; }
    .color-swatch {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid #dee2e6;
      flex-shrink: 0;
    }

    .filters-active {
      margin: 6px 0 4px;
      padding: 4px 2px 0;
      border-bottom: 1px solid #f1f3f5;
      padding-bottom: 8px;
      display: none;
    }

    .filters-active-summary {
      margin: 10px 0 10px;
      display: none;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      border: 1px solid #e1e5eb;
      border-radius: 12px;
      padding: 10px 12px;
      background: #fff;
      font-size: .9rem;
      color: #333;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
    }
    .filters-active-summary span {
      background: #f1f3f5;
      border-radius: 999px;
      padding: 4px 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 700;
      color: #545454;
      border: 1px solid #dfe5ef;
    }
    .filters-active-summary .summary-title {
      background: transparent;
      border-color: transparent;
      color: #6c757d;
      padding: 0;
      font-weight: 700;
    }

    .filters-active-title {
      font-weight: 700;
      font-size: .9rem;
      color: #343a40;
      margin-bottom: 4px;
    }

    .filters-active-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .filter-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid #ced4da;
      background: #fff;
      font-size: .8rem;
      cursor: pointer;
    }

    .filter-chip-label {
      margin-right: 2px;
    }

    .filter-chip-x {
      font-size: .8rem;
      line-height: 1;
    }

    .filters-panel-close {
      border:0;
      background:transparent;
      color:#495057;
      font-weight:700;
      border-radius:999px;
      padding:6px 12px;
      display:none;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:background .2s ease, color .2s ease, box-shadow .2s ease;
    }
    .filters-panel-close i { font-size:1rem; }
    .filters-panel-close:hover { background:#f1f3f5; }
    .filters-panel-close:focus-visible { outline:2px solid var(--primary); outline-offset:2px; box-shadow:0 0 0 3px rgba(232,62,140,.25); }
    .filters-overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      z-index:1100;
      display:none;
    }
    .sr-only {
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      border:0;
    }

    .content-area { min-width:0; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:14px; }
    .card { background:#fff; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.08); overflow:hidden; display:flex; flex-direction:column; }
    .thumb {
      position:relative;
      width:100%;
      aspect-ratio:3 / 4;
      min-height:220px;
      background:#f8f9fb;
      border-radius:12px 12px 0 0;
      overflow:hidden;
      display:block;
    }
    .thumb img {
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:center;
      display:block;
    }
    .variant-row {
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      padding:8px 10px 0;
      align-items:center;
    }
    .variant-swatch {
      width:26px;
      height:26px;
      border-radius:50%;
      border:1px solid #e3e6eb;
      background:#fff;
      background-size:cover;
      background-position:center;
      cursor:pointer;
      padding:0;
    }
    .variant-swatch.is-active {
      border-color: var(--secondary);
      box-shadow:0 0 0 2px rgba(111,66,193,.25);
    }
    .variant-swatch:focus-visible {
      outline:2px solid var(--primary);
      outline-offset:2px;
    }
    .variant-more {
      min-width:30px;
      height:26px;
      border-radius:999px;
      border:1px dashed #d0d5dd;
      background:#f8f9fb;
      color:#6c757d;
      font-size:.75rem;
      font-weight:800;
      padding:0 8px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .badge { position:absolute; top:10px; right:10px; background:#f1f3f5; color:#6c757d; border-radius:999px; padding:5px 9px; font-size:.78rem; font-weight:800; box-shadow:0 4px 12px rgba(0,0,0,.10); }
    .body { padding:10px 12px; display:flex; flex-direction:column; gap:6px; }
    .title { font-size:1rem; font-weight:800; color:#111; cursor:pointer; }
    .subtitle { color:#6c757d; font-size:.9rem; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .price { color: var(--primary); font-weight:900; font-size:1.05rem; }
    .stock { color: var(--success); font-weight:700; font-size:.85rem; text-align:right; }
    .stock small { display:block; color:#6c757d; font-weight:600; }
    .actions { display:flex; gap:8px; margin-top:4px; }
    .btn { flex:1; display:inline-flex; align-items:center; justify-content:center; gap:6px; padding:9px 10px; border-radius:10px; border:1px solid #e9ecef; cursor:pointer; font-weight:800; text-decoration:none; font-size:.95rem; }
    .btn-details { background:#fff; color:#495057; }
    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color:#fff; border:none; }
    .btn:hover { filter:brightness(.98); }
    .skip-link{position:absolute;left:-9999px;top:auto}
    .skip-link:focus{left:12px;top:12px;z-index:9999;background:#fff;color:#000;padding:8px 10px;border-radius:8px}

    footer { background:#343a40; color:#fff; padding:30px 0; margin-top:40px; }
    .footer-grid { max-width:1600px; margin:0 auto; padding:0 28px; display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:30px; }
    .footer-grid h4 { color:#e83e8c; margin-bottom:15px; }
    .footer-grid ul { list-style:none; padding:0; margin:0; }
    .footer-grid li { margin-bottom:10px; color:#adb5bd; }
    .footer-note { text-align:center; padding-top:20px; margin-top:20px; border-top:1px solid #495057; color:#adb5bd; font-size:.9rem; }

    .romix-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      max-width: 280px;
      padding: 10px 14px;
      border-radius: 12px;
      background: #ffffff;
      color: #343a40;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      font-size: 0.9rem;
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: opacity .25s ease, transform .25s ease;
      z-index: 1500;
    }

    .romix-toast--success { border: 2px solid var(--primary); }
    .romix-toast--error { border: 2px solid var(--danger); }

    .romix-toast--visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    @media (max-width: 1100px){
      .layout { grid-template-columns:220px 1fr; gap:12px; }
      .filters-panel { top:100px; }
    }
    @media (max-width: 960px){
      .header-container { grid-template-columns:1fr; grid-template-rows:auto auto auto; padding:0 18px; gap:12px; }
      .global-search { max-width:100%; }
      .topbar-icons { justify-content:flex-end; width:100%; }
      .nav-secondary { padding:0 18px 10px; gap:10px; justify-content:center; flex-wrap:wrap; }
      .nav-secondary a { font-size:.95rem; }
      .layout { grid-template-columns:1fr; }
      .filters-toggle { display:inline-flex; }
      .filters-panel-close { display:flex; }
      .filters-panel { position:fixed; inset:84px 4% auto 4%; width:auto; max-width:420px; z-index:1200; display:none; box-shadow:0 18px 40px rgba(0,0,0,0.25); }
      body.filters-open .filters-panel { display:block; }
      .filters-overlay { display:none; }
      body.filters-open .filters-overlay { display:block; }
    }
    @media (max-width: 720px){
      .toolbar { flex-direction:column; align-items:flex-start; }
      .toolbar input, .toolbar select { width:100%; }
      .toolbar label { width:100%; }
      .grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
    }
    @media (prefers-reduced-motion: reduce){
      .filters-panel,
      .filters-overlay,
      .filters-toggle,
      .filter-item,
      .filters-panel-close { transition-duration:0s !important; animation:none !important; }
    }
  </style>

  <link rel="stylesheet" href="assets/css/responsive.css">
  <link rel="icon" href="images/logo-romix.png" type="image/png" sizes="64x64" />
  <link rel="apple-touch-icon" href="images/logo-romix.png" />
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="ROMIX">
  <meta property="og:title" content="ROMIX | Moda y deportes para todos">
  <meta property="og:description" content="Catalogo completo de ropa para mujer, hombre y ninos. Compra online con envios rapidos y atencion personalizada.">
  <meta property="og:image" content="https://raw.githubusercontent.com/Leandro18122022/web/main/frontend/public/images/logo-romix.png">
  <meta property="og:url" content="https://romix.com/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ROMIX | Moda y deportes para todos">
  <meta name="twitter:description" content="Catalogo completo de ropa para mujer, hombre y ninos. Compra online con envios rapidos y atencion personalizada.">
  <meta name="twitter:image" content="https://raw.githubusercontent.com/Leandro18122022/web/main/frontend/public/images/logo-romix.png">
  <link rel="stylesheet" href="assets/css/romix-header.css">
</head>

<body>
  <a class="skip-link" href="#grid">Saltar al contenido</a>

  <header>
    <div class="header-container topbar">
      <a href="index.html" class="logo" aria-label="Romix">
        <img src="images/logo-romix.png" class="logo-mark" alt="Logo Romix" />
        <span>ROMIX</span>
      </a>
      <form id="global-search-form" class="global-search" role="search" aria-label="Buscar productos">
        <input type="search" name="q" placeholder="Buscar productos..." aria-label="Buscar producto" />
        <button type="submit"><i class="fas fa-search" aria-hidden="true"></i></button>
      </form>
      <div class="topbar-icons" aria-label="Acciones">
        <a class="icon-btn" href="cart.html" aria-label="Carrito"><i class="fas fa-shopping-cart"></i><span class="icon-badge" id="cart-count">0</span></a>
        <a class="icon-btn" href="ayuda.html" aria-label="Ayuda"><i class="fas fa-question-circle"></i></a>
      </div>
    </div>

    <nav class="nav-secondary" aria-label="Secciones y categorias">
      <a href="mujer.html">Mujer</a>
      <a href="hombre.html">Hombre</a>
      <a href="ninos.html">Niños</a>
      <a href="novedades.html" aria-current="page">Novedades</a>
      <a href="ayuda.html">Ayuda</a>
    </nav>
  </header>

  <main class="container" aria-label="Productos destacados">
    <h1 style="margin:6px 2px 14px">Novedades</h1>

    <div class="layout">
      <aside class="filters-panel" id="filters-panel" role="region" aria-labelledby="filters-panel-title" aria-hidden="false">
        <div class="filters-header">
          <div>
            <span class="filters-title" id="filters-panel-title">Filtros</span>
            <small class="filters-subtitle">Selecciona uno o varios</small>
          </div>
          <div class="filters-header-actions">
            <button type="button" class="filters-panel-close" id="filters-panel-close" aria-label="Cerrar filtros">
              <i class="fas fa-times" aria-hidden="true"></i>
              <span>Cerrar</span>
            </button>
            <button type="button" class="filters-clear" id="clear-filters">Limpiar</button>
          </div>
        </div>

        <div class="filters-active" id="filters-active" aria-live="polite"></div>

        <div class="filters-body">
          <fieldset class="filters-group" data-filter-block="types">
            <legend>Categoria</legend>
            <div class="filters-options" id="filter-types"></div>
          </fieldset>
          <fieldset class="filters-group" data-filter-block="seasons">
            <legend>Temporada</legend>
            <div class="filters-options" id="filter-seasons"></div>
          </fieldset>
          <fieldset class="filters-group" data-filter-block="sizes">
            <legend>Talle</legend>
            <div class="filters-options" id="filter-sizes"></div>
          </fieldset>
          <fieldset class="filters-group" data-filter-block="colors">
            <legend>Color</legend>
            <div class="filters-options" id="filter-colors"></div>
          </fieldset>
        </div>
      </aside>

      <div class="content-area">
        <div class="toolbar">
          <button type="button" class="filters-toggle" id="filters-toggle" aria-controls="filters-panel" aria-expanded="false">
            <i class="fas fa-sliders-h" aria-hidden="true"></i> Filtros
          </button>
          <input id="search" type="search" placeholder="Buscar producto..." aria-label="Buscar producto" />
          <label for="sort" style="font-size:.9rem;color:#6c757d">Ordenar:</label>
          <select id="sort" aria-label="Ordenar productos">
            <option value="relevance">Relevancia</option>
            <option value="price-asc">Precio: menor a mayor</option>
            <option value="price-desc">Precio: mayor a menor</option>
            <option value="verano" hidden>Verano</option>
          </select>
          <div id="summary" class="summary" aria-live="polite"></div>
        </div>

        <div class="filters-active-summary" id="filters-active-summary" aria-live="polite"></div>
        <section id="grid" class="grid" aria-live="polite"></section>
      </div>
    </div>
  </main>

  <div class="filters-overlay" id="filters-overlay" tabindex="-1" aria-hidden="true" role="presentation"></div>

  <footer>
    <div class="footer-grid">
      <div>
        <h4>Productos</h4>
        <ul>
          <li><a href="mujer.html" style="color:#adb5bd;text-decoration:none;">Ropa para Mujer</a></li>
          <li><a href="hombre.html" style="color:#adb5bd;text-decoration:none;">Ropa para Hombre</a></li>
          <li><a href="ninos.html" style="color:#adb5bd;text-decoration:none;">Ropa para Niños</a></li>
          <li><a href="novedades.html" style="color:#adb5bd;text-decoration:none;">Novedades</a></li>
          <li><a href="index.html#ofertas" style="color:#adb5bd;text-decoration:none;">Ofertas</a></li>
        </ul>
      </div>
      <div>
        <h4>Ayuda</h4>
        <ul>
          <li><a href="ayuda.html#size-guide" style="color:#adb5bd;text-decoration:none;">Guía de talles</a></li>
          <li><a href="ayuda.html#returns" style="color:#adb5bd;text-decoration:none;">Política de Cambios</a></li>
        </ul>
      </div>
      <div>
        <h4>Contacto</h4>
        <ul>
          <li><a href="ayuda.html#contact" style="color:#adb5bd;text-decoration:none;">Dirección y horarios</a></li>
          <li><a href="https://wa.me/" target="_blank" rel="noopener" style="color:#adb5bd;text-decoration:none;">WhatsApp</a></li>
          <li><a href="tel:+549000000000" style="color:#adb5bd;text-decoration:none;">Llamar por teléfono</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-note">&copy; 2025 Romix - Todos los derechos reservados</div>
  </footer>

  <script src="assets/js/slugify.js"></script>
  <script src="assets/js/cart.js"></script>
  <script src="assets/js/verano-order.js"></script>
  <script src="assets/js/catalog-relevance-order.js"></script>
  <script src="assets/js/season-filter.js"></script>

  <script>
    let romixToastTimer;

    function showToast(message, type = 'success') {
      const el = document.getElementById('romix-toast');
      if (!el) return;

      el.textContent = message || '';

      el.classList.remove('romix-toast--success', 'romix-toast--error');
      if (type === 'error') el.classList.add('romix-toast--error');
      else el.classList.add('romix-toast--success');

      el.classList.add('romix-toast--visible');

      if (romixToastTimer) clearTimeout(romixToastTimer);
      romixToastTimer = setTimeout(() => {
        el.classList.remove('romix-toast--visible');
      }, 2500);
    }
  </script>

  <script>
    const SECTION = 'novedades';
    const PLACEHOLDER = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`\
        <svg xmlns="http://www.w3.org/2000/svg" width="600" height="400">\
          <rect width="100%" height="100%" fill="#f8f9fb"/>\
          <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#adb5bd" font-family="Segoe UI, sans-serif" font-size="22">Imagen no disponible</text>\
        </svg>`);
    const MAX_SWATCHES = 5;
    const preloadedVariantImages = new Set();

    function isValidText(value){
      return typeof value === 'string' && value.trim().length > 0 && value.trim().toLowerCase() !== 'null';
    }
    function isColorValue(value){
      if (!isValidText(value)) return false;
      const s = value.trim();
      return /^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(s) || /^rgb\(/i.test(s) || /^hsl\(/i.test(s);
    }
    function normalizeVariantLabel(value){
      return isValidText(value) ? value.trim() : 'Variante';
    }
    function normalizeImageUrl(value){
      return isValidText(value) ? value.trim() : '';
    }
    function normalizeSwatchValue(value){
      return isValidText(value) ? value.trim() : '';
    }
    function preloadImage(src){
      if (!isValidText(src) || preloadedVariantImages.has(src)) return;
      const img = new Image();
      img.src = src;
      preloadedVariantImages.add(src);
    }

    // ==== MAPA DE COLORES CANANICOS PARA FILTROS ====
    const COLOR_DEFINITIONS = [
      { key:"multicolor", label:"Multicolor", hex:"#f7c948", aliases:["multicolor","estampado","estampada","print","floreado"] },
      { key:"negro",      label:"Negro",      hex:"#000000", aliases:["negro","black","hex","name"] },
      { key:"blanco",     label:"Blanco",     hex:"#ffffff", aliases:["blanco","white"] },
      { key:"azul",       label:"Azul",       hex:"#007bff", aliases:["azul","azul jaspeado","azul oscuro","azul marino"] },
      { key:"rosa",       label:"Rosa",       hex:"#ff69b4", aliases:["rosa","fucsia"] },
      { key:"verde",      label:"Verde",      hex:"#28a745", aliases:["verde","verde jaspeado"] },
      { key:"rojo",       label:"Rojo",       hex:"#dc3545", aliases:["rojo","rojo jaspeado"] },
      { key:"morado",     label:"Violeta",    hex:"#6f42c1", aliases:["violeta","morado","purpura"] },
      { key:"naranja",    label:"Naranja",    hex:"#fd7e14", aliases:["naranja"] },
      { key:"amarillo",   label:"Amarillo",   hex:"#ffc107", aliases:["amarillo"] },
      { key:"marron",     label:"Marron",     hex:"#795548", aliases:["marron","chocolate","caqui"] },
      { key:"gris",       label:"Gris",       hex:"#adb5bd", aliases:["gris","gris jaspeado","gris oscuro","gris medio"] },
    ];

    const COLOR_BY_KEY = {};
    const COLOR_ALIAS_MAP = {};
    const DYNAMIC_COLOR_HEX = Object.create(null);

    function normalizeColorText(name){
      const raw = String(name || '').trim();
      if (!raw) return '';
      let clean = raw;
      try { clean = decodeURIComponent(escape(clean)); } catch {}
      try { clean = clean.normalize('NFD').replace(/\p{Diacritic}+/gu, ''); } catch {}
      return clean.toLowerCase();
    }

    COLOR_DEFINITIONS.forEach(def => {
      COLOR_BY_KEY[def.key] = def;
      def.aliases.forEach(a => {
        const key = normalizeColorText(a);
        if (key) COLOR_ALIAS_MAP[key] = def.key;
      });
    });

    // ? CORREGIDO: "unico" / "único" no se toma como color
    function canonicalColorKey(name){
      const raw = normalizeColorText(name);
      if (!raw) return '';
      if (raw === 'unico' || raw === 'unica' || raw === 'único' || raw === 'úñica') return '';
      if (/^estampad/.test(raw)) return 'multicolor';
      if (COLOR_ALIAS_MAP[raw]) return COLOR_ALIAS_MAP[raw];
      return raw;
    }

    function colorLabelFromKey(key){
      const def = COLOR_BY_KEY[key];
      if (def) return def.label;
      return key.charAt(0).toUpperCase() + key.slice(1);
    }

    function registerFilterColorHex(key, color){
      if (!key || !color) return;
      if (DYNAMIC_COLOR_HEX[key]) return;
      const candidate = color.hex || color.color || color.value || color.hexCode || color.colorHex;
      const normalized = candidate ? String(candidate).trim() : '';
      if (normalized) DYNAMIC_COLOR_HEX[key] = normalized;
    }

    function colorHexFromKey(key){
      if (!key) return '#ffffff';
      if (DYNAMIC_COLOR_HEX[key]) return DYNAMIC_COLOR_HEX[key];
      const def = COLOR_BY_KEY[key];
      return def && def.hex ? def.hex : '#ffffff';
    }

    const esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    function fixUtf8(s){
      if (!s || typeof s !== 'string') return s;
      let out = s;
      try { out = decodeURIComponent(escape(out)); } catch {}
      return out;
    }

    function normalizeProduct(p){
      const copy = Object.assign({}, p);

      ['name','type','section','badge','description'].forEach(k => {
        if (copy[k]) copy[k] = fixUtf8(String(copy[k]));
      });

      // Asegurar que colors SIEMPRE sea un array
      if (!Array.isArray(copy.colors)) {
        if (copy.colors && typeof copy.colors === "object") {
          // Caso: { "Negro": "url" }
          copy.colors = Object.keys(copy.colors).map(k => ({
            name: fixUtf8(k),
            url: copy.colors[k]
          }));
        } else {
          // string, null, undefined, etc.
          copy.colors = [];
        }
      }

      // ? NUEVO: si no hay colors pero hay images, inferir colors desde keys de images
      if ((!copy.colors || copy.colors.length === 0) && copy.images && typeof copy.images === "object") {
        copy.colors = Object.keys(copy.images).map(k => ({
          name: fixUtf8(k),
          url: copy.images[k]
        }));
      }

      return copy;
    }

    const shouldHideProduct = typeof window.romixShouldHideProduct === 'function'
      ? window.romixShouldHideProduct
      : function(p){ return false; };

    const filterVisibleProducts = list => (Array.isArray(list) ? list : []).filter(p => !shouldHideProduct(p));
    const filterState = { sizes:new Set(), colors:new Set(), types:new Set(), seasons:new Set() };
    const priceGroupLabels = { common:'Precio base', special:'Precio especial', special2:'Precio special 2' };
    const seasonFilter = (window.romixSeasonFilter && typeof window.romixSeasonFilter.seasonKeyForProduct === 'function')
      ? window.romixSeasonFilter
      : {
          seasonKeyForProduct: () => 'media-estacion',
          seasonLabelFromKey: key => (key === 'verano' ? 'Verano' : 'Media estacion')
        };
    const FILTER_CONTAINER = { types:'filter-types', sizes:'filter-sizes', colors:'filter-colors', seasons:'filter-seasons' };

    const sharedSlugify = (function(){
      if (typeof window.romixSlugify === 'function') return window.romixSlugify;
      if (typeof window.slugify === 'function') return window.slugify;
      if (window.romix && typeof window.romix.slugify === 'function') return window.romix.slugify;
      throw new Error('Romix slugify helper is not available');
    })();

    function detailHref(product, buy, selection){
      const slugVal = typeof window.romixSlug === 'function'
        ? window.romixSlug(product && product.name ? product.name : '')
        : sharedSlugify(product && product.name ? product.name : '');
      const nameVal = typeof window.fixUtf8 === 'function'
        ? window.fixUtf8(product && product.name ? product.name : '')
        : (product && product.name ? product.name : '');
      const pid = typeof window.productId === 'function' ? window.productId(product) : slugVal;
      const params = new URLSearchParams();
      params.set('id', pid);
      params.set('slug', slugVal);
      params.set('name', nameVal);
      if (selection && selection.color) params.set('color', selection.color);
      if (selection && selection.variantId) params.set('variant', selection.variantId);
      if (selection && selection.image) params.set('variantImage', selection.image);
      if (buy) params.set('buy', '1');
      return 'product.html?' + params.toString();
    }

    function estimateStock(p){
      try {
        if (typeof p.stock === 'number') return Math.max(0, p.stock);
        const sizes = Array.isArray(p.sizes) ? p.sizes : [];
        const perSize = sizes.reduce((t, s) => {
          const st = String(s.status||'').toLowerCase();
          if (st.includes('out') || st.includes('unavail')) return t;
          if (st.includes('low')) return t + 2;
          return t + 5;
        }, 0);
        const colorsCount = Array.isArray(p.colors) && p.colors.length ? p.colors.length : (p.images ? Object.keys(p.images).length : 1);
        return perSize * Math.max(1, colorsCount);
      } catch { return 0; }
    }

    function safeGetCart(){ try { return (window.romixCart && window.romixCart.getCart()) || []; } catch { return []; } }
    function safeSetCart(v){ try { if (window.romixCart) window.romixCart.saveCart(v); } catch {} }
    function updateCartCount(){ try { if (window.romixCart) window.romixCart.updateBadge(); } catch {} }

    // ? CORREGIDO: NO inventa "Unico", infiere color desde colors o images
    function quickAdd(product, selection){
      const pid = product.id || slugify(product.name || "");

      const inferredColors = Array.isArray(product.colors) && product.colors.length
        ? product.colors.map(c => c && c.name ? String(c.name) : '').filter(Boolean)
        : (product.images && typeof product.images === 'object'
            ? Object.keys(product.images)
            : []);

      // Primer color válido (no "unico")
      const firstColorName =
        inferredColors.find(cn => canonicalColorKey(cn)) ||
        inferredColors[0] ||
        '';

      const selectedColor = selection && selection.color ? String(selection.color) : '';
      const color = selectedColor ? fixUtf8(selectedColor) : (firstColorName ? fixUtf8(firstColorName) : '');

      const primaryImage =
        (selection && selection.image ? selection.image : '') ||
        (product.image) ||
        (product.images && firstColorName && product.images[firstColorName]) ||
        (product.images && (product.images["Negro"] || product.images["negro"] || Object.values(product.images)[0])) ||
        (product.colors && product.colors[0] && product.colors[0].url) ||
        "images/placeholder.jpg";

      let size = "U";
      if (Array.isArray(product.sizes) && product.sizes.length){
        const available = product.sizes.find(s => !/out|unavail/i.test(String(s.status||""))) || product.sizes[0];
        size = String(available.size || "U");
      }

      const stockCheck = (window.romixInventory && typeof window.romixInventory.getStock === 'function')
        ? window.romixInventory.getStock(pid, (color || null), size)
        : null;

      if (stockCheck !== null && stockCheck <= 0) {
        showToast('Sin stock para esta variante', 'error');
        return;
      }

      const price = Number(product.price||0);

      if (window.romixCart && typeof window.romixCart.addToCart === 'function') {
        window.romixCart.addToCart({
          productId: pid,
          name: product.name,
          type: product.type || "",
          color: color || null,
          colorName: color || null,
          size,
          image: primaryImage,
          price,
          qty: 1
        });
        window.romixCart.updateBadge();
      }

      showToast('Se agrego con exito al carrito');
    }

    function buildVariantList(p){
      let variants = [];
      if (Array.isArray(p.colors)) {
        variants = p.colors.map(c => {
          if (!c || typeof c !== 'object') return null;
          const label = normalizeVariantLabel(c.label || c.name);
          const id = c.id || c.variantId || c.variant_id || null;
          const image = normalizeImageUrl(c.image || c.url || '');
          let swatch = normalizeSwatchValue(c.swatch || c.thumb || c.thumbnail || c.preview || c.pattern || '');
          let hex = '';
          if (isColorValue(swatch)) {
            hex = swatch;
            swatch = '';
          }
          if (!hex && isColorValue(c.hex)) hex = String(c.hex).trim();
          if (!hex && isColorValue(c.value)) hex = String(c.value).trim();
          if (!hex && typeof canonicalColorKey === 'function') {
            const mapped = colorHexFromKey(canonicalColorKey(label));
            if (isColorValue(mapped)) hex = mapped;
          }
          if (!isValidText(image)) return null;
          if (!isValidText(swatch) && !isColorValue(hex)) return null;
          return { id, label, image, swatch, hex };
        }).filter(Boolean);
      }
      if (!variants.length && p.images && typeof p.images === 'object') {
        variants = Object.keys(p.images).map(k => {
          const label = normalizeVariantLabel(k);
          const img = normalizeImageUrl(p.images[k]);
          if (!isValidText(img)) return null;
          return { id: null, label, image: img, swatch: img, hex: '' };
        }).filter(Boolean);
      }
      if (!variants.length) return variants;
      const seen = new Set();
      return variants.filter(v => {
        const key = [
          (v.label || '').toLowerCase(),
          (v.image || '').toLowerCase(),
          (v.swatch || '').toLowerCase(),
          (v.hex || '').toLowerCase()
        ].join('|');
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    }

    function setMainImage(imgEl, src, baseAlt, label){
      const nextSrc = isValidText(src) ? src : PLACEHOLDER;
      imgEl.onerror = () => { imgEl.onerror = null; imgEl.src = PLACEHOLDER; };
      imgEl.src = nextSrc;
      imgEl.alt = label ? (baseAlt + ' - ' + label) : baseAlt;
    }

    function getCardSelection(card){
      return {
        color: card.dataset.variantLabel || '',
        variantId: card.dataset.variantId || '',
        image: card.dataset.variantImage || ''
      };
    }

    function createCard(p){
      const imgSrc = p.image || (p.images && (p.images['Negro'] || Object.values(p.images)[0])) || PLACEHOLDER;
      const price = Number(p.price||0).toLocaleString('es-AR');
      const stock = estimateStock(p);
      const stockLabel = stock <= 0 ? 'Agotado' : (stock <= 3 ? 'Por agotarse' : 'Disponible');
      const baseAlt = p.name || '';

      const article = document.createElement('article');
      article.className = 'card';
      article.setAttribute('aria-label', p.name);

      const thumb = document.createElement('div'); thumb.className = 'thumb';
      const img = document.createElement('img'); img.src = imgSrc; img.alt = baseAlt; img.width = 600; img.height = 400; img.onerror = () => { img.onerror = null; img.src = PLACEHOLDER; };
      thumb.appendChild(img);
      thumb.style.cursor = 'pointer';
      thumb.addEventListener('click', () => { location.href = detailHref(p, false, getCardSelection(article)); });
      if (p.badge || p.type){ const badge = document.createElement('span'); badge.className = 'badge'; badge.textContent = p.badge ? p.badge : (p.type || ''); thumb.appendChild(badge); }

      const variants = buildVariantList(p);
      let activeIndex = variants.findIndex(v => (v.image && v.image === imgSrc) || (v.swatch && v.swatch === imgSrc));
      if (activeIndex < 0) activeIndex = 0;
      if (variants[activeIndex]) {
        article.dataset.variantLabel = variants[activeIndex].label || '';
        article.dataset.variantId = variants[activeIndex].id || '';
        article.dataset.variantImage = variants[activeIndex].image || '';
        article.dataset.variantSwatch = variants[activeIndex].swatch || '';
        article.dataset.variantHex = variants[activeIndex].hex || '';
      }

      const body = document.createElement('div'); body.className = 'body';
      const title = document.createElement('div'); title.className = 'title'; title.textContent = p.name;
      const subtitle = document.createElement('div'); subtitle.className = 'subtitle'; const secTxt = p.section ? (String(p.section).charAt(0).toUpperCase()+String(p.section).slice(1)) : ''; subtitle.textContent = [secTxt, p.type || ''].filter(Boolean).join(' | ');
      const row = document.createElement('div'); row.className = 'row';
      const priceEl = document.createElement('div'); priceEl.className = 'price'; priceEl.textContent = '$' + price;
      const stockEl = document.createElement('div'); stockEl.className = 'stock'; stockEl.textContent = stockLabel;
      row.appendChild(priceEl); row.appendChild(stockEl);

      const actions = document.createElement('div'); actions.className = 'actions';
      const details = document.createElement('a'); details.className = 'btn btn-details'; details.href = '#'; details.setAttribute('aria-label', 'Ver detalles de ' + p.name); details.innerHTML = '<i class="fas fa-info-circle" aria-hidden="true"></i> Ver Detalles';
      details.addEventListener('click', (ev) => { ev.preventDefault(); location.href = detailHref(p, false, getCardSelection(article)); });
      const add = document.createElement('button'); add.className = 'btn btn-primary'; add.type = 'button'; add.innerHTML = '<i class="fas fa-cart-plus" aria-hidden="true"></i> Agregar'; add.addEventListener('click', () => quickAdd(p, getCardSelection(article)));
      actions.appendChild(details); actions.appendChild(add);

      body.appendChild(title); body.appendChild(subtitle); body.appendChild(row); body.appendChild(actions);
      article.appendChild(thumb);
      if (variants.length > 1) {
        const visibleVariants = variants.slice(0, MAX_SWATCHES);
        const extraCount = Math.max(0, variants.length - visibleVariants.length);
        const rowSwatches = document.createElement('div');
        rowSwatches.className = 'variant-row';
        rowSwatches.setAttribute('aria-label', 'Variantes disponibles');
        rowSwatches.setAttribute('role', 'list');
        visibleVariants.forEach((v, idx) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'variant-swatch' + (idx === activeIndex ? ' is-active' : '');
          btn.setAttribute('role', 'listitem');
          btn.setAttribute('aria-label', v.label);
          btn.setAttribute('aria-pressed', idx === activeIndex ? 'true' : 'false');
          if (v.swatch) {
            btn.style.backgroundImage = 'url(\"' + v.swatch + '\")';
            const swatchImage = new Image();
            swatchImage.onerror = () => { btn.style.backgroundImage = 'url(\"' + PLACEHOLDER + '\")'; };
            swatchImage.src = v.swatch;
          } else if (v.hex) {
            btn.style.background = v.hex;
          } else {
            btn.style.background = '#f1f3f5';
          }
          btn.addEventListener('mouseenter', () => preloadImage(v.image));
          btn.addEventListener('touchstart', () => preloadImage(v.image), { passive: true });
          btn.addEventListener('click', (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            setMainImage(img, v.image || v.swatch || imgSrc, baseAlt, v.label);
            rowSwatches.querySelectorAll('.variant-swatch').forEach(el => {
              el.classList.remove('is-active');
              el.setAttribute('aria-pressed', 'false');
            });
            btn.classList.add('is-active');
            btn.setAttribute('aria-pressed', 'true');
            article.dataset.variantLabel = v.label || '';
            article.dataset.variantId = v.id || '';
            article.dataset.variantImage = v.image || '';
            article.dataset.variantSwatch = v.swatch || '';
            article.dataset.variantHex = v.hex || '';
          });
          rowSwatches.appendChild(btn);
        });
        if (extraCount > 0) {
          const chip = document.createElement('span');
          chip.className = 'variant-more';
          chip.textContent = '+' + extraCount;
          rowSwatches.appendChild(chip);
        }
        article.appendChild(rowSwatches);
      }
      article.appendChild(body);
      return article;
    }

    let master = [];
    let view = [];
    let timer;
    let filtersPanelOpen = false;

    function slugValue(v){
      return String(v||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
    }

    function renderFilterGroup(group, values){
      const containerId = FILTER_CONTAINER[group];
      const container = document.getElementById(containerId);
      const block = document.querySelector('[data-filter-block="'+group+'"]');
      if (!container || !block) return;

      container.innerHTML = '';
      if (!values.length){
        block.style.display = 'none';
        return;
      }
      let visibleCount = 0;

      values.forEach(val => {
        const valueKey = String(val || '').toLowerCase();
        const isHidden = group === 'seasons' && (valueKey === 'verano' || valueKey === 'invierno');

        let labelText;
        if (group === 'priceGroups') {
          labelText = priceGroupLabels[valueKey] || ('Grupo ' + val);
        } else if (group === 'seasons') {
          labelText = seasonFilter.seasonLabelFromKey(valueKey);
        } else if (group === 'colors') {
          labelText = colorLabelFromKey(valueKey);
        } else {
          labelText = val;
        }

        const inputId = 'flt-' + group + '-' + (slugValue(val) || 'opt');
        const label = document.createElement('label');
        label.className = 'filter-item';

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = inputId;
        input.value = valueKey;
        input.dataset.group = group;
        input.addEventListener('change', onFilterChange);

        const span = document.createElement('span');
        span.textContent = labelText;

        label.appendChild(input);

        if (group === 'colors') {
          const sw = document.createElement('span');
          sw.className = 'color-swatch';
          sw.style.background = colorHexFromKey(valueKey);
          label.appendChild(sw);
        }

        label.appendChild(span);
        if (isHidden) {
          label.classList.add('is-hidden');
        } else {
          visibleCount += 1;
        }
        container.appendChild(label);
      });
      block.style.display = visibleCount ? '' : 'none';
    }

    function collectFilterOptions(list){
      const types = new Set();
      const sizes = new Set();
      const colors = new Set();
      const priceGroups = new Set();
      const seasons = new Set();
      list.forEach(p => {
        if (p.type) types.add(String(p.type).trim());
        (p.sizes || []).forEach(s => { if (s && s.size) sizes.add(String(s.size).trim()); });
        (Array.isArray(p.colors) ? p.colors : []).forEach(c => {
          if (c && c.name){
            const key = canonicalColorKey(c.name);
            if (key){
              registerFilterColorHex(key, c);
              colors.add(key);
            }
          }
        });
        if (p.priceByGroup && typeof p.priceByGroup === 'object'){
          Object.keys(p.priceByGroup).forEach(k => priceGroups.add(String(k).trim()));
        }
        seasons.add(seasonFilter.seasonKeyForProduct(p));
      });
      const seasonOrder = ['verano', 'media-estacion', 'invierno'];
      return {
        types: Array.from(types).sort((a,b)=>a.localeCompare(b)),
        sizes: Array.from(sizes).sort((a,b)=>a.localeCompare(b, undefined, {numeric:true,sensitivity:'base'})),
        colors: Array.from(colors).sort((a,b)=>{
          const la = colorLabelFromKey(a);
          const lb = colorLabelFromKey(b);
          return la.localeCompare(lb, 'es', {sensitivity:'base'});
        }),
        priceGroups: Array.from(priceGroups).sort((a,b)=>a.localeCompare(b)),
        seasons: seasonOrder.filter(key => seasons.has(key))
      };
    }

    function onFilterChange(evt){
      const group = evt.target.dataset.group;
      const val = String(evt.target.value||'').toLowerCase();
      if (!group) return;
      if (evt.target.checked) filterState[group].add(val);
      else filterState[group].delete(val);
      aplicarFiltros();
    }

    function clearFilters(){
      Object.keys(filterState).forEach(k => filterState[k].clear());
      document.querySelectorAll('.filter-item input[type="checkbox"]').forEach(cb => cb.checked = false);
      aplicarFiltros();
    }

    function isMobileView(){ return typeof window !== 'undefined' && typeof window.matchMedia === 'function' && window.matchMedia('(max-width: 960px)').matches; }

    function syncFiltersPanelState(open){
      filtersPanelOpen = open;
      const panel = document.getElementById('filters-panel');
      const overlay = document.getElementById('filters-overlay');
      const toggleBtn = document.getElementById('filters-toggle');
      const mobile = isMobileView();
      if (panel) panel.setAttribute('aria-hidden', mobile && !open ? 'true' : 'false');
      if (overlay) overlay.setAttribute('aria-hidden', mobile && !open ? 'true' : 'false');
      if (toggleBtn) toggleBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
      document.body.classList.toggle('filters-open', open && mobile);
    }

    function toggleFiltersPanel(force){
      if (force && typeof force.preventDefault === 'function'){ force.preventDefault(); force = undefined; }
      const target = typeof force === 'boolean' ? force : !filtersPanelOpen;
      syncFiltersPanelState(target);
    }

    function applyView(){
      const grid = document.getElementById('grid');
      const currentQ = (document.getElementById('search').value||'').trim();
      grid.innerHTML = '';
      if (!view.length){
        grid.innerHTML = '<p style="color:#6c757d;">No se encontraron resultados'+(currentQ ? ' para "'+esc(currentQ)+'"' : '')+' en Novedades.</p>';
      } else {
        view.forEach(p => grid.appendChild(createCard(p)));
      }
      const summary = document.getElementById('summary');
      summary.textContent = 'Mostrando ' + view.length + ' de ' + master.length + ' productos';
    }

    function aplicarFiltros(){
      const q = document.getElementById('search').value.trim();
      const sort = document.getElementById('sort').value;
      const base = (!q ? master.slice() :
        (window.romixSearch && typeof window.romixSearch.searchInList === 'function'
          ? window.romixSearch.searchInList(master, q, {})
          : master.filter(p => {
              const text = [p.name, p.type, p.badge].map(x => String(x||'').toLowerCase()).join(' ');
              return text.includes(q.toLowerCase());
            })
        )
      );

      view = base.filter(p => {
        if (filterState.types.size && !filterState.types.has(String(p.type||'').toLowerCase())) return false;
        if (filterState.seasons.size && !filterState.seasons.has(seasonFilter.seasonKeyForProduct(p))) return false;
        if (filterState.sizes.size){
          const sizes = (p.sizes||[]).map(s=>String(s.size||'').toLowerCase());
          if (!sizes.some(s => filterState.sizes.has(s))) return false;
        }
        if (filterState.colors.size){
          const colors = (p.colors||[]).map(c => canonicalColorKey(c.name)).filter(Boolean);
          if (!colors.some(c => filterState.colors.has(c))) return false;
        }
        return true;
      });

      if (sort === 'price-asc') view.sort((a,b)=> (Number(a.price||0) - Number(b.price||0)));
      else if (sort === 'price-desc') view.sort((a,b)=> (Number(b.price||0) - Number(a.price||0)));
      else if (sort === 'verano' && typeof applyVeranoOrder === 'function') view = applyVeranoOrder(view);
      else if (sort === 'relevance' && typeof applyCatalogRelevanceOrder === 'function') view = applyCatalogRelevanceOrder(view, SECTION);

      applyView();
      updateActiveFiltersUI();
    }

    function updateActiveFiltersUI(){
      const container = document.getElementById('filters-active');
      if (!container) return;

      container.innerHTML = '';
      const chips = [];

      document.querySelectorAll('.filter-item input[type="checkbox"]:checked')
        .forEach(input => {
          const group = input.dataset.group;
          const valueKey = String(input.value || '');
          const labelNode = (function(){
            const label = input.closest('label');
            if (!label) return null;
            const spans = label.querySelectorAll('span');
            return spans.length ? spans[spans.length - 1] : null;
          })();
          const label = labelNode ? labelNode.textContent.trim() : valueKey;
          chips.push({ group, valueKey, label });
        });

      if (typeof priceRange !== 'undefined' &&
          priceRange.max > 0 &&
          (priceRange.currentMin > priceRange.min || priceRange.currentMax < priceRange.max)) {
        chips.push({
          group: 'priceRange',
          valueKey: 'range',
          label: `Precio: ${formatPriceARS(priceRange.currentMin)} \u2013 ${formatPriceARS(priceRange.currentMax)}`
        });
      }

      renderFiltersSummary(chips);
      if (!chips.length){
        container.style.display = 'none';
        return;
      }

      container.style.display = '';

      const title = document.createElement('div');
      title.className = 'filters-active-title';
      title.textContent = `Filtros (${chips.length})`;
      container.appendChild(title);

      const list = document.createElement('div');
      list.className = 'filters-active-chips';

      chips.forEach(ch => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'filter-chip';
        btn.dataset.group = ch.group;
        btn.dataset.valueKey = ch.valueKey;

        const labelSpan = document.createElement('span');
        labelSpan.className = 'filter-chip-label';
        labelSpan.textContent = ch.label;

        const xSpan = document.createElement('span');
        xSpan.className = 'filter-chip-x';
        xSpan.setAttribute('aria-hidden', 'true');
        xSpan.textContent = '?';

        btn.appendChild(labelSpan);
        btn.appendChild(xSpan);
        btn.addEventListener('click', onFilterChipRemove);

        list.appendChild(btn);
      });

      container.appendChild(list);
    }

    function onFilterChipRemove(evt){
      const btn = evt.currentTarget;
      const group = btn.dataset.group;
      const valueKey = btn.dataset.valueKey;

      if (group === 'priceRange' && typeof priceRange !== 'undefined') {
        const minInput = document.getElementById('price-min');
        const maxInput = document.getElementById('price-max');
        const minLabel = document.getElementById('price-min-label');
        const maxLabel = document.getElementById('price-max-label');

        if (minInput && maxInput) {
          minInput.value = String(priceRange.min);
          maxInput.value = String(priceRange.max);
        }

        priceRange.currentMin = priceRange.min;
        priceRange.currentMax = priceRange.max;

        if (minLabel && maxLabel) {
          minLabel.textContent = formatPriceARS(priceRange.currentMin);
          maxLabel.textContent = formatPriceARS(priceRange.currentMax);
        }

        aplicarFiltros();
        return;
      }

      const selector = `.filter-item input[type="checkbox"][data-group="${group}"][value="${CSS.escape(valueKey)}"]`;
      const input = document.querySelector(selector);

      if (input) input.checked = false;

      if (filterState && filterState[group] && filterState[group].delete) {
        filterState[group].delete(valueKey);
      }

      aplicarFiltros();
    }

    function renderFiltersSummary(chips){
      const summaryEl = document.getElementById('filters-active-summary');
      if (!summaryEl) return;
      if (!chips.length){
        summaryEl.style.display = 'none';
        summaryEl.innerHTML = '';
        return;
      }
      summaryEl.style.display = 'flex';
      summaryEl.innerHTML = '';
      const title = document.createElement('span');
      title.className = 'summary-title';
      title.textContent = `Filtros activos (${chips.length})`;
      summaryEl.appendChild(title);
      chips.forEach(ch => {
        const pill = document.createElement('span');
        pill.textContent = ch.label;
        summaryEl.appendChild(pill);
      });
    }

    async function init(){
      updateCartCount();
      try {
        const res = await fetch(new URL('assets/data/products.json', location.href));
        const all = await res.json();
        const clean = Array.isArray(all) ? all.map(normalizeProduct) : [];
        const visible = filterVisibleProducts(clean);

        master = visible.filter(p => p && p.featured === true);

        view = master.slice();
        const filterOptions = collectFilterOptions(master);
        renderFilterGroup('types', filterOptions.types);
        renderFilterGroup('seasons', filterOptions.seasons);
        renderFilterGroup('sizes', filterOptions.sizes);
        renderFilterGroup('colors', filterOptions.colors);
        aplicarFiltros();
      } catch (e) {
        const grid = document.getElementById('grid');
        grid.innerHTML = '<p>Error al cargar productos.</p>';
        console && console.error && console.error('[mujer] Error:', e);
      }

      document.getElementById('search').addEventListener('input', () => { clearTimeout(timer); timer = setTimeout(aplicarFiltros, 120); });
      document.getElementById('sort').addEventListener('change', aplicarFiltros);
      const clearBtn = document.getElementById('clear-filters'); if (clearBtn) clearBtn.addEventListener('click', clearFilters);

      const toggleBtn = document.getElementById('filters-toggle');
      if (toggleBtn) toggleBtn.addEventListener('click', evt => { evt.preventDefault(); toggleFiltersPanel(); });

      const closeBtn = document.getElementById('filters-panel-close');
      if (closeBtn) closeBtn.addEventListener('click', () => toggleFiltersPanel(false));

      const overlay = document.getElementById('filters-overlay');
      if (overlay) overlay.addEventListener('click', () => toggleFiltersPanel(false));

      syncFiltersPanelState(false);
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>

  <script src="assets/js/inventory.js"></script>
  <script src="assets/js/search.js"></script>

  <div id="romix-toast" class="romix-toast" aria-live="polite" role="status"></div>
  <script src="assets/js/romix-header.js"></script>
</body>
</html>

