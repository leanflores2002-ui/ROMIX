<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Romix - Colección Invierno 2025</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <style>
    /* (Mantengo todos los estilos previos tal cual) */
      /* Carousel ofertas */
    .hero { position: relative; max-width: 1200px; margin: 10px auto 0; padding: 0 20px; }
    .hero-wrap { position: relative; border-radius: 14px; overflow: hidden; height: 280px; box-shadow: 0 6px 18px rgba(0,0,0,.12); }
    .hero-slide { position: absolute; inset: 0; opacity: 0; transition: opacity .6s ease; background:#111; display:flex; align-items:center; justify-content:center; }
    .hero-slide img { width: 100%; height:100%; object-fit: cover; }
    .hero-slide.active { opacity: 1; }
    .hero-controls { position: absolute; inset: 0; display:flex; align-items: center; justify-content: space-between; padding: 0 8px; pointer-events:none; }
    .hero-btn { pointer-events: all; background: rgba(0,0,0,.45); border: none; color:#fff; width:38px; height:38px; border-radius: 999px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .hero-dots { position:absolute; bottom:8px; left:0; right:0; dis
  <!-- reCAPTCHA v3 (invisible) -->
  <!-- Reemplazá YOUR_RECAPTCHA_SITE_KEY con tu clave de sitio -->
  <script src="https://www.google.com/recaptcha/api.js?render=YOUR_RECAPTCHA_SITE_KEY"></script>
</head>
<body>
  <!-- (Mantengo header, nav, secciones y footer igual que antes) -->

  <!-- MODAL de revisión/confirmación con edición -->
  <div id="review-modal" class="modal" aria-hidden="true">
    <div class="modal-content animate__animated animate__fadeIn">
      <h3>Revisar pedido</h3>
      <div class="modal-row">
        <div class="modal-thumb"><img id="review-image" alt="Producto" /></div>
        <div>
          <div class="summary">
            <p><strong id="review-name">Producto</strong> <span id="review-type" style="color:#6c757d"></span></p>
            <div class="price-line"><span>Precio unitario</span><strong>$<span id="review-price">0</span></strong></div>
            <div class="price-line"><span>Subtotal</span><strong>$<span id="review-subtotal">0</span></strong></div>
            <p id="review-stock" style="margin-top:6px;color:#6c757d;">Stock disponible: -</p>
          </div>

          <label for="review-color">Color</label>
          <select id="review-color"></select>

          <label for="review-size">Talle</label>
          <select id="review-size"></select>

          <label for="review-qty">Cantidad</label>
          <div class="quantity-control" style="margin-top:4px;">
            <button class="btn quantity-btn" id="qty-dec">−</button>
            <input type="number" id="review-qty" class="quantity-input" min="1" value="1" />
            <button class="btn quantity-btn" id="qty-inc">+</button>
          </div>

          <div class="modal-actions">
            <button class="btn btn-outline" onclick="closeReviewModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="confirmReviewToCart()"><i class="fas fa-check"></i> Confirmar compra</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    let currentProduct = null;
    let currentType = null;
    let productsData = [];

    document.addEventListener('DOMContentLoaded', () => {
      loadProducts();
      updateCart();
    });

    function loadProducts() {
      fetch('products.json')
        .then((r) => r.json())
        .then((products) => {
          productsData = products;
          const sections = {
            mujer: document.getElementById('mujer-grid'),
            hombre: document.getElementById('hombre-grid'),
            ninos: document.getElementById('ninos-grid'),
          };

          products.forEach((product) => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.dataset.type = product.type;

            let priceHTML = `$${Number(product.price).toLocaleString('es-AR')}`;
            if (product.originalPrice) {
              priceHTML += ` <small>$${Number(product.originalPrice).toLocaleString('es-AR')}</small>`;
            }

            let badgeHTML = product.badge ? `<span class="product-badge">${product.badge}</span>` : '';

            let colorsHTML = product.colors
              .map((color) =>
                `<div class="color-option" style="background-color:${color.hex}; ${color.hex === '#ffffff' ? 'border:1px solid #ddd;' : ''}" title="${color.name}" data-color="${color.name}" data-image="${color.image || product.image}"></div>`
              )
              .join('');

            let sizesHTML = product.sizes
              .map((size) => `<span class="size-option ${size.status}" data-size="${size.size}">${size.size}</span>`)
              .join('');

            card.innerHTML = `
              <div class="product-image">
                <img src="${product.image}" alt="${product.name}" loading="lazy" data-default="${product.image}" />
                ${badgeHTML}
              </div>
              <div class="product-info">
                <h3 class="product-title">${product.name}</h3>
                <div class="product-price">${priceHTML}</div>
                <div class="product-colors">${colorsHTML}</div>
                <div class="product-sizes">
                  <div class="size-title">Talles disponibles:</div>
                  <div class="size-options">${sizesHTML}</div>
                </div>
                <div class="quantity-control">
                  <span class="quantity-title">Cantidad:</span>
                  <button class="btn quantity-btn decrease">-</button>
                  <input type="number" class="quantity-input" min="1" value="1" />
                  <button class="btn quantity-btn increase">+</button>
                </div>
                <div class="product-actions">
                  <button class="btn btn-primary">Comprar</button>
                  <button class="btn btn-outline"><i class="far fa-heart"></i></button>
                </div>
              </div>`;

            sections[product.section].appendChild(card);

            card.querySelectorAll('.color-option').forEach((el) => el.addEventListener('click', () => selectColor(el, card)));
            card.querySelectorAll('.size-option').forEach((el) => el.addEventListener('click', () => selectSize(el)));
            initQtyControls(card);
            card.querySelector('.btn.btn-primary').addEventListener('click', () => openReview(card, product));
          });

          filterProducts('mujer', 'all');
          filterProducts('hombre', 'all');
          filterProducts('ninos', 'all');
        })
        .catch((e) => console.error('Error al cargar productos:', e.message));
    }

    function initQtyControls(card) {
      const dec = card.querySelector('.decrease');
      const inc = card.querySelector('.increase');
      const input = card.querySelector('.quantity-input');
      dec.addEventListener('click', () => { const v = parseInt(input.value) || 1; if (v > 1) input.value = v - 1; });
      inc.addEventListener('click', () => { const v = parseInt(input.value) || 1; input.value = v + 1; });
      input.addEventListener('input', () => { let v = parseInt(input.value); if (isNaN(v) || v < 1) input.value = 1; });
    }

    function selectColor(el, card) {
      card.querySelectorAll('.color-option').forEach((c) => c.classList.remove('selected'));
      el.classList.add('selected');
      // Cambiar imagen al seleccionar color
      const img = card.querySelector('.product-image img');
      const newImage = el.getAttribute('data-image');
      if (newImage) img.src = newImage;
    }

    function selectSize(el) {
      const card = el.closest('.product-card');
      card.querySelectorAll('.size-option').forEach((s) => s.classList.remove('selected'));
      el.classList.add('selected');
    }

    function openReview(card, product) {
      const colorEl = card.querySelector('.color-option.selected');
      const sizeEl = card.querySelector('.size-option.selected');
      if (!colorEl || !sizeEl) {
        alert('Por favor, seleccioná un color y un talle antes de continuar.');
        return;
      }
      currentProduct = product.name;
      currentType = product.type;
      const selectedColor = colorEl.dataset.color;
      const selectedSize = sizeEl.dataset.size;
      const qty = parseInt(card.querySelector('.quantity-input').value) || 1;
      const modal = document.getElementById('review-modal');
      document.getElementById('review-image').src = card.querySelector('.product-image img').src;
      document.getElementById('review-name').textContent = product.name;
      document.getElementById('review-type').textContent = `(${product.type})`;
      const unitPrice = Number(product.price);
      document.getElementById('review-price').textContent = unitPrice.toFixed(2);
      const colorSel = document.getElementById('review-color');
      colorSel.innerHTML = '';
      product.colors.forEach((c) => {
        const opt = document.createElement('option');
        opt.value = c.name; opt.textContent = c.name; if (c.name === selectedColor) opt.selected = true; colorSel.appendChild(opt);
      });
      const sizeSel = document.getElementById('review-size');
      sizeSel.innerHTML = '';
      product.sizes.forEach((s) => {
        const opt = document.createElement('option');
        opt.value = s.size; opt.textContent = s.size; opt.disabled = s.status === 'unavailable';
        if (s.size === selectedSize) opt.selected = true; sizeSel.appendChild(opt);
      });
      const qtyInput = document.getElementById('review-qty');
      const stockInfo = document.getElementById('review-stock');
      const stock = product.stock || 9999;
      stockInfo.textContent = `Stock disponible: ${stock}`;
      qtyInput.value = Math.min(qty, stock);
      const updateSubtotal = () => {
        const q = Math.max(1, Math.min(parseInt(qtyInput.value) || 1, stock));
        qtyInput.value = q;
        document.getElementById('review-subtotal').textContent = (unitPrice * q).toFixed(2);
      };
      document.getElementById('qty-dec').onclick = () => { qtyInput.value = Math.max(1, (parseInt(qtyInput.value) || 1) - 1); updateSubtotal(); };
      document.getElementById('qty-inc').onclick = () => { qtyInput.value = Math.min(stock, (parseInt(qtyInput.value) || 1) + 1); updateSubtotal(); };
      qtyInput.oninput = updateSubtotal;
      updateSubtotal();
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
    }

    function closeReviewModal() {
      const modal = document.getElementById('review-modal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
      currentProduct = null;
      currentType = null;
    }

    function confirmReviewToCart() {
      const name = document.getElementById('review-name').textContent;
      const color = document.getElementById('review-color').value;
      const size = document.getElementById('review-size').value;
      const qty = parseInt(document.getElementById('review-qty').value) || 1;
      const unit = parseFloat(document.getElementById('review-price').textContent);
      const subtotal = unit * qty;
      const item = { id: Date.now(), name, type: currentType, color, size, quantity: qty, price: unit, subtotal };
      cart.push(item);
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCart();
      closeReviewModal();
      alert('¡Listo! Se agregó al carrito.');
    }

    function removeFromCart(id) {
      cart = cart.filter((it) => it.id !== id);
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCart();
    }

    function clearCart() {
      cart = [];
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCart();
    }

    function updateCart() {
      const body = document.getElementById('cart-items');
      const totalEl = document.getElementById('cart-total');
      const countEl = document.getElementById('cart-count');
      let total = 0, count = 0;
      body.innerHTML = '';
      cart.forEach((item) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.name}</td>
          <td>${item.type}</td>
          <td>${item.color}</td>
          <td>${item.size}</td>
          <td>${item.quantity}</td>
          <td>$${item.price.toFixed(2)}</td>
          <td>$${item.subtotal.toFixed(2)}</td>
          <td><button class="btn btn-danger" onclick="removeFromCart(${item.id})"><i class="fas fa-trash"></i></button></td>`;
        body.appendChild(tr);
        total += item.subtotal; count += item.quantity;
      });
      totalEl.textContent = total.toFixed(2);
      countEl.textContent = count;
      const cartSection = document.getElementById('cart');
      if (cart.length === 0) cartSection.classList.add('hidden'); else cartSection.classList.remove('hidden');
    }

    function toggleCart() {
      const sec = document.getElementById('cart');
      sec.classList.toggle('hidden');
      if (!sec.classList.contains('hidden')) {
        sec.classList.add('animate__animated', 'animate__fadeIn');
        setTimeout(() => sec.classList.remove('animate__animated', 'animate__fadeIn'), 800);
      }
    }

    // reCAPTCHA invisible para proteger el envío
    function sendToWhatsApp() {
      if (cart.length === 0) { alert('El carrito está vacío.'); return; }
      grecaptcha.ready(function() {
        grecaptcha.execute('TU_SITE_KEY', {action: 'submit'}).then(function(token) {
          let message = '¡Hola! Quiero realizar el siguiente pedido:\n\n';
          cart.forEach((item) => {
            message += `${item.name} (${item.type})\n`;
            message += `Color: ${item.color}\n`;
            message += `Talle: ${item.size}\n`;
            message += `Cantidad: ${item.quantity}\n`;
            message += `Subtotal: $${item.subtotal.toFixed(2)}\n\n`;
          });
          message += `Total: $${cart.reduce((t, i) => t + i.subtotal, 0).toFixed(2)}`;
          const encoded = encodeURIComponent(message);
          const phone = '+5491154272065';
          window.open(`https://wa.me/${phone}?text=${encoded}`, '_blank');
        });
      });
    }
  </script>
  <!-- Overrides: imagen por color + envío con reCAPTCHA -->
  <script>
    // Sobrescribe selectColor para cambiar imagen por color (si hay asset por color)
    window.selectColor = function(el) {
      const card = el.closest('.product-card');
      card.querySelectorAll('.color-option').forEach((c) => c.classList.remove('selected'));
      el.classList.add('selected');
      try {
        const name = card.querySelector('.product-title').textContent;
        const product = (window.productsData || []).find((p) => p.name === name);
        const imgEl = card.querySelector('.product-image img');
        const base = imgEl.getAttribute('data-default') || imgEl.src;
        if (product) {
          const colorName = el.dataset.color;
          const colorObj = (product.colors || []).find((c) => c.name === colorName);
          imgEl.src = (colorObj && colorObj.image) ? colorObj.image : base;
        }
      } catch (e) { /* no-op */ }
    };

    // Sobrescribe openReview para que el modal use la imagen del color seleccionado
    window.openReview = function(card, product) {
      const colorEl = card.querySelector('.color-option.selected');
      const sizeEl = card.querySelector('.size-option.selected');
      if (!colorEl || !sizeEl) { alert('Por favor, seleccioná un color y un talle antes de continuar.'); return; }

      window.currentProduct = product.name;
      window.currentType = product.type;

      const selectedColor = colorEl.dataset.color;
      const selectedSize = sizeEl.dataset.size;
      const qty = parseInt(card.querySelector('.quantity-input').value) || 1;

      const modal = document.getElementById('review-modal');
      const baseImg = card.querySelector('.product-image img').getAttribute('data-default');
      const colorObj = (product.colors || []).find((c) => c.name === selectedColor);
      document.getElementById('review-image').src = (colorObj && colorObj.image) ? colorObj.image : baseImg;

      document.getElementById('review-name').textContent = product.name;
      document.getElementById('review-type').textContent = `(${product.type})`;
      const unitPrice = Number(product.price);
      document.getElementById('review-price').textContent = unitPrice.toFixed(2);

      const colorSel = document.getElementById('review-color');
      colorSel.innerHTML = '';
      (product.colors || []).forEach((c) => {
        const opt = document.createElement('option');
        opt.value = c.name; opt.textContent = c.name; if (c.name === selectedColor) opt.selected = true; colorSel.appendChild(opt);
      });

      const sizeSel = document.getElementById('review-size');
      sizeSel.innerHTML = '';
      (product.sizes || []).forEach((s) => {
        const opt = document.createElement('option');
        opt.value = s.size; opt.textContent = s.size + (s.status === 'unavailable' ? ' (sin stock)' : '');
        opt.disabled = s.status === 'unavailable';
        if (s.size === selectedSize) opt.selected = true;
        sizeSel.appendChild(opt);
      });

      const qtyInput = document.getElementById('review-qty');
      const stockInfo = document.getElementById('review-stock');
      const stock = product.stock || 9999;
      stockInfo.textContent = `Stock disponible: ${stock}`;
      qtyInput.value = Math.min(qty, stock);

      const updateSubtotal = () => {
        const q = Math.max(1, Math.min(parseInt(qtyInput.value) || 1, stock));
        qtyInput.value = q;
        document.getElementById('review-subtotal').textContent = (unitPrice * q).toFixed(2);
      };
      document.getElementById('qty-dec').onclick = () => { qtyInput.value = Math.max(1, (parseInt(qtyInput.value) || 1) - 1); updateSubtotal(); };
      document.getElementById('qty-inc').onclick = () => { qtyInput.value = Math.min(stock, (parseInt(qtyInput.value) || 1) + 1); updateSubtotal(); };
      qtyInput.oninput = updateSubtotal;

      colorSel.onchange = () => {
        const sel = colorSel.value;
        const cObj = (product.colors || []).find((c) => c.name === sel);
        document.getElementById('review-image').src = (cObj && cObj.image) ? cObj.image : baseImg;
      };

      updateSubtotal();
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
    };

    // Sobrescribe sendToWhatsApp para usar reCAPTCHA v3 (invisible)
    window.sendToWhatsApp = function() {
      if ((window.cart || []).length === 0) { alert('El carrito está vacío. Agregá productos antes de enviar el pedido.'); return; }

      // rate limit simple
      const now = Date.now();
      const last = Number(localStorage.getItem('last_send_ts') || 0);
      if (now - last < 8000) { alert('Esperá unos segundos antes de enviar otro pedido.'); return; }

      const buildMessage = () => {
        let message = '¡Hola! Quiero realizar el siguiente pedido:

';
        window.cart.forEach((item) => {
          message += `${item.name} (${item.type})
`;
          message += `Color: ${item.color}
`;
          message += `Talle: ${item.size}
`;
          message += `Cantidad: ${item.quantity}
`;
          message += `Subtotal: $${item.subtotal.toFixed(2)}

`;
        });
        message += `Total: $${window.cart.reduce((t, i) => t + i.subtotal, 0).toFixed(2)}`;
        return message;
      };

      if (typeof grecaptcha === 'undefined') { alert('No se pudo cargar reCAPTCHA. Verificá la clave del sitio.'); return; }

      grecaptcha.ready(function() {
        grecaptcha.execute('YOUR_RECAPTCHA_SITE_KEY', { action: 'send_whatsapp' }).then(function(token) {
          if (!token) { alert('No se pudo validar reCAPTCHA.'); return; }
          const encoded = encodeURIComponent(buildMessage());
          const phone = '+5491154272065';
          const waUrl = `https://wa.me/${phone}?text=${encoded}%0A%0Aref%3Drecaptcha_${encodeURIComponent(token.slice(0,20))}`;
          localStorage.setItem('last_send_ts', String(Date.now()));
          window.open(waUrl, '_blank');
        });
      });
    };
  </script>
</body>
</html>
